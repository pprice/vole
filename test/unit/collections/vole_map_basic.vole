// Tests for pure Vole Map core (std:collections/map)

let { Map } = import "std:collections/map"

tests {
    test "vole_map::new creates empty map" {
        let m = Map.new<i64, i64>()
        assert(m.len() == 0)
        assert(m.is_empty())
    }

    test "vole_map::set and get i64/i64" {
        let m = Map.new<i64, i64>()
        m.set(1, 100)
        m.set(2, 200)

        assert(m.len() == 2)
        assert(m.get(1) == 100)
        assert(m.get(2) == 200)
    }

    test "vole_map::contains_key" {
        let m = Map.new<i64, i64>()
        m.set(10, 99)

        assert(m.contains_key(10))
        assert(!m.contains_key(11))
    }

    test "vole_map::get missing returns nil" {
        let m = Map.new<i64, i64>()
        m.set(3, 30)

        assert(m.get(3) == 30)
        assert(m.get(999) == nil)
    }

    test "vole_map::remove existing returns value" {
        let m = Map.new<i64, i64>()
        m.set(1, 10)
        m.set(2, 20)

        let removed = m.remove(1)
        assert(removed == 10)
        assert(m.len() == 1)
        assert(!m.contains_key(1))
        assert(m.contains_key(2))
    }

    test "vole_map::remove missing returns nil" {
        let m = Map.new<i64, i64>()
        assert(m.remove(404) == nil)
    }

    test "vole_map::clear resets map" {
        let m = Map.new<i64, i64>()
        m.set(1, 10)
        m.set(2, 20)
        m.clear()

        assert(m.len() == 0)
        assert(m.is_empty())
        assert(m.get(1) == nil)
        assert(m.get(2) == nil)
    }

    test "vole_map::overwrite existing key" {
        let m = Map.new<i64, i64>()
        m.set(1, 10)
        m.set(1, 99)

        assert(m.len() == 1)
        assert(m.get(1) == 99)
    }

    test "vole_map::with_capacity" {
        let m = Map.with_capacity<i64, i64>(100)
        assert(m.len() == 0)
        assert(m.is_empty())

        m.set(7, 70)
        assert(m.get(7) == 70)
    }

    test "vole_map::rehash preserves entries" {
        let m = Map.new<i64, i64>()

        // Insert enough entries to trigger growth from the initial capacity.
        let mut i = 0
        while i < 40 {
            m.set(i, i * 100)
            i = i + 1
        }

        assert(m.len() == 40)

        let mut j = 0
        while j < 40 {
            assert(m.get(j) == j * 100)
            j = j + 1
        }
    }

    test "vole_map::i64 to string" {
        let m = Map.new<i64, string>()
        m.set(1, "one")
        m.set(2, "two")

        assert((m.get(1) ?? "") == "one")
        assert((m.get(2) ?? "") == "two")
        assert(m.get(3) == nil)
    }

    test "vole_map::string to string" {
        let m = Map.new<string, string>()
        m.set("a", "alpha")
        m.set("b", "beta")

        assert((m.get("a") ?? "") == "alpha")
        assert((m.get("b") ?? "") == "beta")
        assert(m.get("c") == nil)
    }
}
