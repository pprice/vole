// Test: Map with custom types for both K and V
// Exercises Map<K, V> where both K and V are user-defined classes.
//
// NOTE: Multiple test blocks with Map<CustomClass, CustomClass> trigger
// a pre-existing codegen bug with && in equals closures across compilation
// units. All scenarios are combined into a single test to work around this.

class Point {
    x: i64,
    y: i64,
}

implement Hashable for Point {
    func hash() -> i64 {
        return self.x * 31 + self.y
    }
}

implement Equatable for Point {
    func equals(other: Point) -> bool {
        return self.x == other.x && self.y == other.y
    }
}

tests {
    test "map<Point, Point> custom type for both K and V" {
        let m = Map.new<Point, Point>()
        let k1 = Point { x: 1, y: 2 }
        let v1 = Point { x: 100, y: 200 }
        let k2 = Point { x: 3, y: 4 }
        let v2 = Point { x: 300, y: 400 }

        m.set(k1, v1)
        m.set(k2, v2)

        assert(m.len() == 2)

        let got1 = m.get(k1) ?? Point { x: 0, y: 0 }
        assert(got1.x == 100)
        assert(got1.y == 200)

        let got2 = m.get(k2) ?? Point { x: 0, y: 0 }
        assert(got2.x == 300)
        assert(got2.y == 400)

        // Update value for existing key
        let v1_new = Point { x: 111, y: 222 }
        m.set(k1, v1_new)
        assert(m.len() == 2)
        let got1_new = m.get(k1) ?? Point { x: 0, y: 0 }
        assert(got1_new.x == 111)
        assert(got1_new.y == 222)

        // Contains key
        assert(m.contains_key(k1))
        assert(m.contains_key(k2))
        let missing = Point { x: 99, y: 99 }
        assert(!m.contains_key(missing))

        // Get missing
        assert(m.get(missing) == nil)

        // Remove
        _ = m.remove(k1)
        assert(m.len() == 1)
        assert(m.get(k1) == nil)

        // Remove missing
        assert(m.remove(missing) == nil)
        assert(m.len() == 1)

        // is_empty and clear
        assert(!m.is_empty())
        m.clear()
        assert(m.is_empty())
        assert(m.len() == 0)
    }
}
