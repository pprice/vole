// Tests for stdlib/json.vole - JsonObject, JsonArray, JsonError, JSON, JsonParseResult, and annotation types
let { JsonObject, JsonArray, JsonError, json_name, json_ignore, JSON, JsonParseResult } = import "std:json"

tests "JsonObject construction" {
    test "new creates empty object" {
        let obj = JsonObject.new()
        assert(obj.len() == 0)
    }
}

tests "JsonObject set and get" {
    test "set and get string value" {
        let obj = JsonObject.new()
        obj.set("name", "Alice")
        let v = obj.get("name")
        if v is string {
            assert(v == "Alice")
        } else {
            assert(false)
        }
    }

    test "set and get f64 value" {
        let obj = JsonObject.new()
        obj.set("pi", 3.14)
        let v = obj.get("pi")
        if v is f64 {
            assert(v == 3.14)
        } else {
            assert(false)
        }
    }

    test "set and get bool true" {
        let obj = JsonObject.new()
        obj.set("flag", true)
        let v = obj.get("flag")
        if v is bool {
            assert(v == true)
        } else {
            assert(false)
        }
    }

    test "set and get bool false" {
        let obj = JsonObject.new()
        obj.set("disabled", false)
        let v = obj.get("disabled")
        if v is bool {
            assert(v == false)
        } else {
            assert(false)
        }
    }

    test "set and get nil value" {
        let obj = JsonObject.new()
        obj.set("nothing", nil)
        // Note: get returns nil for both absent keys and null values.
        // Use contains_key to distinguish.
        assert(obj.contains_key("nothing"))
        assert(obj.get("nothing") is nil)
    }

    test "get missing key returns nil" {
        let obj = JsonObject.new()
        assert(obj.get("missing") is nil)
    }

    test "overwrite existing key" {
        let obj = JsonObject.new()
        obj.set("key", "first")
        obj.set("key", "second")
        assert(obj.len() == 1)
        let v = obj.get("key")
        if v is string {
            assert(v == "second")
        } else {
            assert(false)
        }
    }

    test "overwrite string with f64" {
        let obj = JsonObject.new()
        obj.set("x", "hello")
        obj.set("x", 42.0)
        let v = obj.get("x")
        if v is f64 {
            assert(v == 42.0)
        } else {
            assert(false)
        }
    }

    test "multiple keys" {
        let obj = JsonObject.new()
        obj.set("a", "alpha")
        obj.set("b", "beta")
        obj.set("c", "gamma")
        assert(obj.len() == 3)

        let a = obj.get("a")
        let b = obj.get("b")
        let c = obj.get("c")
        if a is string {
            assert(a == "alpha")
        } else {
            assert(false)
        }
        if b is string {
            assert(b == "beta")
        } else {
            assert(false)
        }
        if c is string {
            assert(c == "gamma")
        } else {
            assert(false)
        }
    }
}

tests "JsonObject contains_key" {
    test "contains_key for present key" {
        let obj = JsonObject.new()
        obj.set("x", 1.0)
        assert(obj.contains_key("x"))
    }

    test "contains_key for absent key" {
        let obj = JsonObject.new()
        assert(!obj.contains_key("x"))
    }

    test "contains_key after remove" {
        let obj = JsonObject.new()
        obj.set("x", 1.0)
        _ = obj.remove("x")
        assert(!obj.contains_key("x"))
    }

    test "contains_key for nil value" {
        let obj = JsonObject.new()
        obj.set("null_val", nil)
        assert(obj.contains_key("null_val"))
    }
}

tests "JsonObject remove" {
    test "remove existing key returns value" {
        let obj = JsonObject.new()
        obj.set("key", "value")
        let removed = obj.remove("key")
        if removed is string {
            assert(removed == "value")
        } else {
            assert(false)
        }
        assert(obj.len() == 0)
    }

    test "remove missing key returns nil" {
        let obj = JsonObject.new()
        assert(obj.remove("missing") is nil)
    }

    test "remove does not affect other keys" {
        let obj = JsonObject.new()
        obj.set("a", 1.0)
        obj.set("b", 2.0)
        obj.set("c", 3.0)
        _ = obj.remove("b")
        assert(obj.len() == 2)
        assert(obj.contains_key("a"))
        assert(!obj.contains_key("b"))
        assert(obj.contains_key("c"))
    }
}

tests "JsonObject keys" {
    test "keys count on empty object" {
        let obj = JsonObject.new()
        assert(obj.keys().count() == 0)
    }

    test "keys count matches len" {
        let obj = JsonObject.new()
        obj.set("a", 1.0)
        obj.set("b", 2.0)
        obj.set("c", 3.0)
        assert(obj.keys().count() == 3)
        assert(obj.keys().count() == obj.len())
    }
}

tests "JsonObject nested objects" {
    test "nested JsonObject" {
        let inner = JsonObject.new()
        inner.set("x", 10.0)
        inner.set("y", 20.0)

        let outer = JsonObject.new()
        outer.set("point", inner)

        let got = outer.get("point")
        if got is JsonObject {
            let x = got.get("x")
            if x is f64 {
                assert(x == 10.0)
            } else {
                assert(false)
            }
            let y = got.get("y")
            if y is f64 {
                assert(y == 20.0)
            } else {
                assert(false)
            }
        } else {
            assert(false)
        }
    }

    test "nested JsonArray in object" {
        let arr = JsonArray.new()
        arr.push(1.0)
        arr.push(2.0)
        arr.push(3.0)

        let obj = JsonObject.new()
        obj.set("nums", arr)

        let got = obj.get("nums")
        if got is JsonArray {
            assert(got.length() == 3)
            let first = got.get(0)
            if first is f64 {
                assert(first == 1.0)
            } else {
                assert(false)
            }
        } else {
            assert(false)
        }
    }
}

tests "JsonArray construction" {
    test "new creates empty array" {
        let arr = JsonArray.new()
        assert(arr.length() == 0)
    }
}

tests "JsonArray push and get" {
    test "push and get string" {
        let arr = JsonArray.new()
        arr.push("hello")
        assert(arr.length() == 1)
        let v = arr.get(0)
        if v is string {
            assert(v == "hello")
        } else {
            assert(false)
        }
    }

    test "push and get f64" {
        let arr = JsonArray.new()
        arr.push(42.0)
        let v = arr.get(0)
        if v is f64 {
            assert(v == 42.0)
        } else {
            assert(false)
        }
    }

    test "push and get bool" {
        let arr = JsonArray.new()
        arr.push(true)
        arr.push(false)
        let v0 = arr.get(0)
        let v1 = arr.get(1)
        if v0 is bool {
            assert(v0 == true)
        } else {
            assert(false)
        }
        if v1 is bool {
            assert(v1 == false)
        } else {
            assert(false)
        }
    }

    test "push and get nil" {
        let arr = JsonArray.new()
        arr.push(nil)
        assert(arr.get(0) is nil)
    }

    test "mixed type array" {
        let arr = JsonArray.new()
        arr.push("hello")
        arr.push(42.0)
        arr.push(true)
        arr.push(nil)
        assert(arr.length() == 4)

        let v0 = arr.get(0)
        if v0 is string {
            assert(v0 == "hello")
        } else {
            assert(false)
        }

        let v1 = arr.get(1)
        if v1 is f64 {
            assert(v1 == 42.0)
        } else {
            assert(false)
        }

        let v2 = arr.get(2)
        if v2 is bool {
            assert(v2 == true)
        } else {
            assert(false)
        }

        assert(arr.get(3) is nil)
    }

    test "multiple pushes grow length" {
        let arr = JsonArray.new()
        var i: f64 = 0.0
        while i < 10.0 {
            arr.push(i)
            i = i + 1.0
        }
        assert(arr.length() == 10)
    }
}

tests "JsonArray nested" {
    test "nested JsonObject in array" {
        let obj = JsonObject.new()
        obj.set("key", "value")

        let arr = JsonArray.new()
        arr.push(obj)

        let got = arr.get(0)
        if got is JsonObject {
            let v = got.get("key")
            if v is string {
                assert(v == "value")
            } else {
                assert(false)
            }
        } else {
            assert(false)
        }
    }

    test "nested JsonArray in array" {
        let inner = JsonArray.new()
        inner.push(1.0)
        inner.push(2.0)

        let outer = JsonArray.new()
        outer.push(inner)

        let got = outer.get(0)
        if got is JsonArray {
            assert(got.length() == 2)
            let v = got.get(1)
            if v is f64 {
                assert(v == 2.0)
            } else {
                assert(false)
            }
        } else {
            assert(false)
        }
    }
}

tests "deeply nested JSON structures" {
    test "object with array of objects" {
        // Build: { "users": [{ "name": "Alice", "age": 30.0 }, { "name": "Bob", "age": 25.0 }] }
        let alice = JsonObject.new()
        alice.set("name", "Alice")
        alice.set("age", 30.0)

        let bob = JsonObject.new()
        bob.set("name", "Bob")
        bob.set("age", 25.0)

        let users = JsonArray.new()
        users.push(alice)
        users.push(bob)

        let root = JsonObject.new()
        root.set("users", users)

        // Navigate
        let arr = root.get("users")
        if arr is JsonArray {
            assert(arr.length() == 2)

            let first = arr.get(0)
            if first is JsonObject {
                let name = first.get("name")
                if name is string {
                    assert(name == "Alice")
                } else {
                    assert(false)
                }
                let age = first.get("age")
                if age is f64 {
                    assert(age == 30.0)
                } else {
                    assert(false)
                }
            } else {
                assert(false)
            }

            let second = arr.get(1)
            if second is JsonObject {
                let name = second.get("name")
                if name is string {
                    assert(name == "Bob")
                } else {
                    assert(false)
                }
            } else {
                assert(false)
            }
        } else {
            assert(false)
        }
    }

    test "three levels of nesting" {
        // { "level1": { "level2": { "level3": "deep" } } }
        let l3 = JsonObject.new()
        l3.set("level3", "deep")

        let l2 = JsonObject.new()
        l2.set("level2", l3)

        let l1 = JsonObject.new()
        l1.set("level1", l2)

        let got_l2 = l1.get("level1")
        if got_l2 is JsonObject {
            let got_l3 = got_l2.get("level2")
            if got_l3 is JsonObject {
                let v = got_l3.get("level3")
                if v is string {
                    assert(v == "deep")
                } else {
                    assert(false)
                }
            } else {
                assert(false)
            }
        } else {
            assert(false)
        }
    }

    test "array of arrays" {
        // [[1.0, 2.0], [3.0, 4.0]]
        let row1 = JsonArray.new()
        row1.push(1.0)
        row1.push(2.0)

        let row2 = JsonArray.new()
        row2.push(3.0)
        row2.push(4.0)

        let matrix = JsonArray.new()
        matrix.push(row1)
        matrix.push(row2)

        assert(matrix.length() == 2)

        let r0 = matrix.get(0)
        if r0 is JsonArray {
            assert(r0.length() == 2)
            let v = r0.get(1)
            if v is f64 {
                assert(v == 2.0)
            } else {
                assert(false)
            }
        } else {
            assert(false)
        }

        let r1 = matrix.get(1)
        if r1 is JsonArray {
            let v = r1.get(0)
            if v is f64 {
                assert(v == 3.0)
            } else {
                assert(false)
            }
        } else {
            assert(false)
        }
    }

    test "complex mixed structure" {
        // { "config": { "enabled": true, "tags": ["a", "b"], "count": 5.0 } }
        let tags = JsonArray.new()
        tags.push("a")
        tags.push("b")

        let config = JsonObject.new()
        config.set("enabled", true)
        config.set("tags", tags)
        config.set("count", 5.0)

        let root = JsonObject.new()
        root.set("config", config)

        let cfg = root.get("config")
        if cfg is JsonObject {
            let enabled = cfg.get("enabled")
            if enabled is bool {
                assert(enabled == true)
            } else {
                assert(false)
            }

            let t = cfg.get("tags")
            if t is JsonArray {
                assert(t.length() == 2)
                let first_tag = t.get(0)
                if first_tag is string {
                    assert(first_tag == "a")
                } else {
                    assert(false)
                }
            } else {
                assert(false)
            }

            let cnt = cfg.get("count")
            if cnt is f64 {
                assert(cnt == 5.0)
            } else {
                assert(false)
            }
        } else {
            assert(false)
        }
    }
}

tests "JsonObject edge cases" {
    test "empty string key" {
        let obj = JsonObject.new()
        obj.set("", "empty key")
        let v = obj.get("")
        if v is string {
            assert(v == "empty key")
        } else {
            assert(false)
        }
    }

    test "empty string value" {
        let obj = JsonObject.new()
        obj.set("key", "")
        let v = obj.get("key")
        if v is string {
            assert(v == "")
        } else {
            assert(false)
        }
    }

    test "zero f64 value" {
        let obj = JsonObject.new()
        obj.set("zero", 0.0)
        let v = obj.get("zero")
        if v is f64 {
            assert(v == 0.0)
        } else {
            assert(false)
        }
    }

    test "negative f64 value" {
        let obj = JsonObject.new()
        obj.set("neg", -42.5)
        let v = obj.get("neg")
        if v is f64 {
            assert(v == -42.5)
        } else {
            assert(false)
        }
    }

    test "many keys triggers rehash" {
        let obj = JsonObject.new()
        var i: f64 = 0.0
        while i < 20.0 {
            let key = i.to_string()
            obj.set(key, i)
            i = i + 1.0
        }
        assert(obj.len() == 20)

        // Verify all keys still accessible after rehash
        var j: f64 = 0.0
        while j < 20.0 {
            let key = j.to_string()
            let v = obj.get(key)
            if v is f64 {
                assert(v == j)
            } else {
                assert(false)
            }
            j = j + 1.0
        }
    }
}

tests "JsonError construction" {
    test "new creates error with message and position" {
        let err = JsonError.new("unexpected token", 42)
        assert(err.message == "unexpected token")
        assert(err.position == 42)
    }

    test "new with zero position" {
        let err = JsonError.new("unexpected end of input", 0)
        assert(err.message == "unexpected end of input")
        assert(err.position == 0)
    }

    test "new with large position" {
        let err = JsonError.new("invalid escape sequence", 10000)
        assert(err.message == "invalid escape sequence")
        assert(err.position == 10000)
    }

    test "new with empty message" {
        let err = JsonError.new("", 5)
        assert(err.message == "")
        assert(err.position == 5)
    }
}

tests "JsonError to_string" {
    test "to_string formats message and position" {
        let err = JsonError.new("unexpected token", 42)
        assert(err.to_string() == "JsonError at position 42: unexpected token")
    }

    test "to_string at position zero" {
        let err = JsonError.new("unexpected end of input", 0)
        assert(err.to_string() == "JsonError at position 0: unexpected end of input")
    }

    test "to_string with empty message" {
        let err = JsonError.new("", 10)
        assert(err.to_string() == "JsonError at position 10: ")
    }
}

tests "JsonError as Stringable" {
    test "JsonError accepted as Stringable" {
        let err = JsonError.new("bad value", 7)
        let s: Stringable = err
        assert(s.to_string() == "JsonError at position 7: bad value")
    }
}

tests "json_name annotation" {
    test "json_name can be constructed with a name" {
        let ann = json_name { name: "user_name" }
        assert(ann.name == "user_name")
    }

    test "json_name with empty string" {
        let ann = json_name { name: "" }
        assert(ann.name == "")
    }

    test "json_name with special characters" {
        let ann = json_name { name: "my-field_1" }
        assert(ann.name == "my-field_1")
    }
}

tests "json_ignore annotation" {
    test "json_ignore can be constructed" {
        let ann = json_ignore {}
        _ = ann
    }
}

// =============================================================================
// JSON.stringify tests
// =============================================================================

tests "JSON.stringify primitives" {
    test "stringify string" {
        assert(JSON.stringify("hello") == "\"hello\"")
    }

    test "stringify empty string" {
        assert(JSON.stringify("") == "\"\"")
    }

    test "stringify string with quotes" {
        assert(JSON.stringify("say \"hi\"") == "\"say \\\"hi\\\"\"")
    }

    test "stringify string with backslash" {
        assert(JSON.stringify("a\\b") == "\"a\\\\b\"")
    }

    test "stringify string with newline" {
        assert(JSON.stringify("line1\nline2") == "\"line1\\nline2\"")
    }

    test "stringify string with tab" {
        assert(JSON.stringify("a\tb") == "\"a\\tb\"")
    }

    test "stringify string with carriage return" {
        assert(JSON.stringify("a\rb") == "\"a\\rb\"")
    }

    test "stringify integer f64" {
        assert(JSON.stringify(42.0) == "42")
    }

    test "stringify decimal f64" {
        assert(JSON.stringify(3.14) == "3.14")
    }

    test "stringify zero f64" {
        assert(JSON.stringify(0.0) == "0")
    }

    test "stringify negative f64" {
        assert(JSON.stringify(-1.5) == "-1.5")
    }

    test "stringify true" {
        assert(JSON.stringify(true) == "true")
    }

    test "stringify false" {
        assert(JSON.stringify(false) == "false")
    }

    test "stringify nil" {
        assert(JSON.stringify(nil) == "null")
    }
}

tests "JSON.stringify objects" {
    test "stringify empty object" {
        let obj = JsonObject.new()
        assert(JSON.stringify(obj) == "{{}}")
    }

    test "stringify object with string value" {
        let obj = JsonObject.new()
        obj.set("name", "Alice")
        assert(JSON.stringify(obj) == "{{\"name\":\"Alice\"}}")
    }

    test "stringify object with number value" {
        let obj = JsonObject.new()
        obj.set("age", 30.0)
        assert(JSON.stringify(obj) == "{{\"age\":30}}")
    }

    test "stringify object with bool value" {
        let obj = JsonObject.new()
        obj.set("active", true)
        assert(JSON.stringify(obj) == "{{\"active\":true}}")
    }

    test "stringify object with nil value" {
        let obj = JsonObject.new()
        obj.set("data", nil)
        assert(JSON.stringify(obj) == "{{\"data\":null}}")
    }

    test "stringify object with multiple keys" {
        let obj = JsonObject.new()
        obj.set("a", 1.0)
        obj.set("b", 2.0)
        // Order depends on Map iteration, but result must be valid JSON
        let s = JSON.stringify(obj)
        assert(s.contains("\"a\":1"))
        assert(s.contains("\"b\":2"))
    }

    test "stringify nested object" {
        let inner = JsonObject.new()
        inner.set("x", 10.0)
        let outer = JsonObject.new()
        outer.set("point", inner)
        assert(JSON.stringify(outer) == "{{\"point\":{{\"x\":10}}}}")
    }
}

tests "JSON.stringify arrays" {
    test "stringify empty array" {
        let arr = JsonArray.new()
        assert(JSON.stringify(arr) == "[]")
    }

    test "stringify array of numbers" {
        let arr = JsonArray.new()
        arr.push(1.0)
        arr.push(2.0)
        arr.push(3.0)
        assert(JSON.stringify(arr) == "[1,2,3]")
    }

    test "stringify array of strings" {
        let arr = JsonArray.new()
        arr.push("a")
        arr.push("b")
        assert(JSON.stringify(arr) == "[\"a\",\"b\"]")
    }

    test "stringify mixed array" {
        let arr = JsonArray.new()
        arr.push(1.0)
        arr.push("two")
        arr.push(true)
        arr.push(nil)
        assert(JSON.stringify(arr) == "[1,\"two\",true,null]")
    }

    test "stringify nested array" {
        let inner = JsonArray.new()
        inner.push(1.0)
        inner.push(2.0)
        let outer = JsonArray.new()
        outer.push(inner)
        assert(JSON.stringify(outer) == "[[1,2]]")
    }

    test "stringify array with object" {
        let obj = JsonObject.new()
        obj.set("id", 1.0)
        let arr = JsonArray.new()
        arr.push(obj)
        assert(JSON.stringify(arr) == "[{{\"id\":1}}]")
    }
}

// =============================================================================
// JSON.stringify_pretty tests
// =============================================================================

tests "JSON.stringify_pretty" {
    test "pretty print empty object" {
        let obj = JsonObject.new()
        assert(JSON.stringify_pretty(obj) == "{{}}")
    }

    test "pretty print empty array" {
        let arr = JsonArray.new()
        assert(JSON.stringify_pretty(arr) == "[]")
    }

    test "pretty print primitive" {
        assert(JSON.stringify_pretty("hello") == "\"hello\"")
        assert(JSON.stringify_pretty(42.0) == "42")
        assert(JSON.stringify_pretty(true) == "true")
        assert(JSON.stringify_pretty(nil) == "null")
    }

    test "pretty print object with one key" {
        let obj = JsonObject.new()
        obj.set("name", "Alice")
        let s = JSON.stringify_pretty(obj)
        assert(s.contains("\"name\": \"Alice\""))
        assert(s.contains("  "))
    }

    test "pretty print array" {
        let arr = JsonArray.new()
        arr.push(1.0)
        arr.push(2.0)
        let s = JSON.stringify_pretty(arr)
        assert(s.contains("  1"))
        assert(s.contains("  2"))
    }
}

// =============================================================================
// JSON.parse tests
// =============================================================================

tests "JSON.parse primitives" {
    test "parse null" {
        let r = JSON.parse("null")
        assert(r.ok)
        assert(r.is_nil())
    }

    test "parse true" {
        let r = JSON.parse("true")
        assert(r.ok)
        assert(r.is_bool())
        assert(r.as_bool() == true)
    }

    test "parse false" {
        let r = JSON.parse("false")
        assert(r.ok)
        assert(r.is_bool())
        assert(r.as_bool() == false)
    }

    test "parse integer" {
        let r = JSON.parse("42")
        assert(r.ok)
        assert(r.is_f64())
        assert(r.as_f64() == 42.0)
    }

    test "parse negative integer" {
        let r = JSON.parse("-7")
        assert(r.ok)
        assert(r.is_f64())
        assert(r.as_f64() == -7.0)
    }

    test "parse decimal" {
        let r = JSON.parse("3.14")
        assert(r.ok)
        assert(r.is_f64())
        // Compare with tolerance
        let v = r.as_f64()
        assert(v > 3.13 && v < 3.15)
    }

    test "parse negative decimal" {
        let r = JSON.parse("-0.5")
        assert(r.ok)
        assert(r.is_f64())
        assert(r.as_f64() == -0.5)
    }

    test "parse zero" {
        let r = JSON.parse("0")
        assert(r.ok)
        assert(r.is_f64())
        assert(r.as_f64() == 0.0)
    }

    test "parse string" {
        let r = JSON.parse("\"hello\"")
        assert(r.ok)
        assert(r.is_string())
        assert(r.as_string() == "hello")
    }

    test "parse empty string" {
        let r = JSON.parse("\"\"")
        assert(r.ok)
        assert(r.is_string())
        assert(r.as_string() == "")
    }

    test "parse string with escapes" {
        let r = JSON.parse("\"a\\nb\"")
        assert(r.ok)
        assert(r.is_string())
        assert(r.as_string() == "a\nb")
    }

    test "parse string with escaped quote" {
        let r = JSON.parse("\"say \\\"hi\\\"\"")
        assert(r.ok)
        assert(r.is_string())
        assert(r.as_string() == "say \"hi\"")
    }

    test "parse string with backslash" {
        let r = JSON.parse("\"a\\\\b\"")
        assert(r.ok)
        assert(r.is_string())
        assert(r.as_string() == "a\\b")
    }

    test "parse string with tab escape" {
        let r = JSON.parse("\"a\\tb\"")
        assert(r.ok)
        assert(r.as_string() == "a\tb")
    }

    test "parse string with unicode escape" {
        let r = JSON.parse("\"\\u0041\"")
        assert(r.ok)
        assert(r.as_string() == "A")
    }
}

tests "JSON.parse numbers" {
    test "parse number with exponent" {
        let r = JSON.parse("1e2")
        assert(r.ok)
        assert(r.is_f64())
        assert(r.as_f64() == 100.0)
    }

    test "parse number with positive exponent" {
        let r = JSON.parse("1E+2")
        assert(r.ok)
        assert(r.as_f64() == 100.0)
    }

    test "parse number with negative exponent" {
        let r = JSON.parse("100e-2")
        assert(r.ok)
        assert(r.as_f64() == 1.0)
    }

    test "parse large integer" {
        let r = JSON.parse("1000000")
        assert(r.ok)
        assert(r.as_f64() == 1000000.0)
    }
}

tests "JSON.parse arrays" {
    test "parse empty array" {
        let r = JSON.parse("[]")
        assert(r.ok)
        assert(r.is_array())
        assert(r.as_array().length() == 0)
    }

    test "parse array of numbers" {
        let r = JSON.parse("[1, 2, 3]")
        assert(r.ok)
        assert(r.is_array())
        let arr = r.as_array()
        assert(arr.length() == 3)
        let v0 = arr.get(0)
        if v0 is f64 { assert(v0 == 1.0) } else { assert(false) }
        let v1 = arr.get(1)
        if v1 is f64 { assert(v1 == 2.0) } else { assert(false) }
        let v2 = arr.get(2)
        if v2 is f64 { assert(v2 == 3.0) } else { assert(false) }
    }

    test "parse array of strings" {
        let r = JSON.parse("[\"a\", \"b\"]")
        assert(r.ok)
        let arr = r.as_array()
        assert(arr.length() == 2)
        let v = arr.get(0)
        if v is string { assert(v == "a") } else { assert(false) }
    }

    test "parse mixed array" {
        let r = JSON.parse("[1, \"two\", true, null]")
        assert(r.ok)
        let arr = r.as_array()
        assert(arr.length() == 4)
        assert(arr.get(0) is f64)
        assert(arr.get(1) is string)
        assert(arr.get(2) is bool)
        assert(arr.get(3) is nil)
    }

    test "parse nested array" {
        let r = JSON.parse("[[1, 2], [3, 4]]")
        assert(r.ok)
        let arr = r.as_array()
        assert(arr.length() == 2)
        let inner = arr.get(0)
        if inner is JsonArray {
            assert(inner.length() == 2)
        } else {
            assert(false)
        }
    }

    test "parse array with whitespace" {
        let r = JSON.parse("  [ 1 , 2 , 3 ]  ")
        assert(r.ok)
        assert(r.as_array().length() == 3)
    }
}

tests "JSON.parse objects" {
    test "parse empty object" {
        let r = JSON.parse("{{}}")
        assert(r.ok)
        assert(r.is_object())
        assert(r.as_object().len() == 0)
    }

    test "parse object with string value" {
        let r = JSON.parse("{{\"name\": \"Alice\"}}")
        assert(r.ok)
        assert(r.is_object())
        let obj = r.as_object()
        let v = obj.get("name")
        if v is string { assert(v == "Alice") } else { assert(false) }
    }

    test "parse object with number value" {
        let r = JSON.parse("{{\"age\": 30}}")
        assert(r.ok)
        let obj = r.as_object()
        let v = obj.get("age")
        if v is f64 { assert(v == 30.0) } else { assert(false) }
    }

    test "parse object with bool value" {
        let r = JSON.parse("{{\"active\": true}}")
        assert(r.ok)
        let obj = r.as_object()
        let v = obj.get("active")
        if v is bool { assert(v == true) } else { assert(false) }
    }

    test "parse object with null value" {
        let r = JSON.parse("{{\"data\": null}}")
        assert(r.ok)
        let obj = r.as_object()
        assert(obj.contains_key("data"))
        assert(obj.get("data") is nil)
    }

    test "parse object with multiple keys" {
        let r = JSON.parse("{{\"a\": 1, \"b\": 2, \"c\": 3}}")
        assert(r.ok)
        let obj = r.as_object()
        assert(obj.len() == 3)
        let a = obj.get("a")
        if a is f64 { assert(a == 1.0) } else { assert(false) }
    }

    test "parse nested object" {
        let r = JSON.parse("{{\"inner\": {{\"x\": 10}}}}")
        assert(r.ok)
        let obj = r.as_object()
        let inner = obj.get("inner")
        if inner is JsonObject {
            let x = inner.get("x")
            if x is f64 { assert(x == 10.0) } else { assert(false) }
        } else {
            assert(false)
        }
    }

    test "parse object with array value" {
        let r = JSON.parse("{{\"items\": [1, 2, 3]}}")
        assert(r.ok)
        let obj = r.as_object()
        let items = obj.get("items")
        if items is JsonArray {
            assert(items.length() == 3)
        } else {
            assert(false)
        }
    }
}

tests "JSON.parse errors" {
    test "parse empty string" {
        let r = JSON.parse("")
        assert(!r.ok)
    }

    test "parse invalid token" {
        let r = JSON.parse("bad")
        assert(!r.ok)
        assert(r.err.position == 0)
    }

    test "parse trailing content" {
        let r = JSON.parse("true false")
        assert(!r.ok)
        assert(r.err.message == "unexpected trailing content")
    }

    test "parse unterminated string" {
        let r = JSON.parse("\"hello")
        assert(!r.ok)
    }

    test "parse unterminated array" {
        let r = JSON.parse("[1, 2")
        assert(!r.ok)
    }

    test "parse unterminated object" {
        let r = JSON.parse("{{\"a\": 1")
        assert(!r.ok)
    }

    test "parse invalid number" {
        let r = JSON.parse("-")
        assert(!r.ok)
    }

    test "parse error has position" {
        let r = JSON.parse("   bad")
        assert(!r.ok)
        assert(r.err.position == 3)
    }

    test "parse error to_string" {
        let r = JSON.parse("bad")
        assert(!r.ok)
        let s = r.err.to_string()
        assert(s.contains("position"))
    }
}

tests "JSON.parse whitespace handling" {
    test "parse with leading whitespace" {
        let r = JSON.parse("  42  ")
        assert(r.ok)
        assert(r.as_f64() == 42.0)
    }

    test "parse with tabs and newlines" {
        let r = JSON.parse("\t\n42\n\t")
        assert(r.ok)
        assert(r.as_f64() == 42.0)
    }
}

tests "JSON.parse type checking methods" {
    test "is_string returns true for strings" {
        let r = JSON.parse("\"hello\"")
        assert(r.is_string())
        assert(!r.is_f64())
        assert(!r.is_bool())
        assert(!r.is_nil())
        assert(!r.is_object())
        assert(!r.is_array())
    }

    test "is_f64 returns true for numbers" {
        let r = JSON.parse("42")
        assert(!r.is_string())
        assert(r.is_f64())
        assert(!r.is_bool())
        assert(!r.is_nil())
        assert(!r.is_object())
        assert(!r.is_array())
    }

    test "is_bool returns true for booleans" {
        let r = JSON.parse("true")
        assert(!r.is_string())
        assert(!r.is_f64())
        assert(r.is_bool())
        assert(!r.is_nil())
        assert(!r.is_object())
        assert(!r.is_array())
    }

    test "is_nil returns true for null" {
        let r = JSON.parse("null")
        assert(!r.is_string())
        assert(!r.is_f64())
        assert(!r.is_bool())
        assert(r.is_nil())
        assert(!r.is_object())
        assert(!r.is_array())
    }

    test "is_object returns true for objects" {
        let r = JSON.parse("{{}}")
        assert(!r.is_string())
        assert(!r.is_f64())
        assert(!r.is_bool())
        assert(!r.is_nil())
        assert(r.is_object())
        assert(!r.is_array())
    }

    test "is_array returns true for arrays" {
        let r = JSON.parse("[]")
        assert(!r.is_string())
        assert(!r.is_f64())
        assert(!r.is_bool())
        assert(!r.is_nil())
        assert(!r.is_object())
        assert(r.is_array())
    }
}

tests "JSON roundtrip" {
    test "roundtrip string" {
        let r = JSON.parse(JSON.stringify("hello"))
        assert(r.ok)
        assert(r.as_string() == "hello")
    }

    test "roundtrip number" {
        let r = JSON.parse(JSON.stringify(42.0))
        assert(r.ok)
        assert(r.as_f64() == 42.0)
    }

    test "roundtrip bool true" {
        let r = JSON.parse(JSON.stringify(true))
        assert(r.ok)
        assert(r.as_bool() == true)
    }

    test "roundtrip bool false" {
        let r = JSON.parse(JSON.stringify(false))
        assert(r.ok)
        assert(r.as_bool() == false)
    }

    test "roundtrip null" {
        let r = JSON.parse(JSON.stringify(nil))
        assert(r.ok)
        assert(r.is_nil())
    }

    test "roundtrip object" {
        let obj = JsonObject.new()
        obj.set("name", "Alice")
        obj.set("age", 30.0)
        let text = JSON.stringify(obj)
        let r = JSON.parse(text)
        assert(r.ok)
        assert(r.is_object())
        let parsed = r.as_object()
        let name = parsed.get("name")
        if name is string { assert(name == "Alice") } else { assert(false) }
        let age = parsed.get("age")
        if age is f64 { assert(age == 30.0) } else { assert(false) }
    }

    test "roundtrip array" {
        let arr = JsonArray.new()
        arr.push(1.0)
        arr.push("two")
        arr.push(true)
        arr.push(nil)
        let text = JSON.stringify(arr)
        let r = JSON.parse(text)
        assert(r.ok)
        assert(r.is_array())
        let parsed = r.as_array()
        assert(parsed.length() == 4)
    }

    test "roundtrip nested structure" {
        let inner = JsonObject.new()
        inner.set("x", 1.0)
        inner.set("y", 2.0)
        let arr = JsonArray.new()
        arr.push(inner)
        let outer = JsonObject.new()
        outer.set("points", arr)
        let text = JSON.stringify(outer)
        let r = JSON.parse(text)
        assert(r.ok)
        assert(r.is_object())
        let robj = r.as_object()
        let pts = robj.get("points")
        if pts is JsonArray {
            assert(pts.length() == 1)
            let p = pts.get(0)
            if p is JsonObject {
                let x = p.get("x")
                if x is f64 { assert(x == 1.0) } else { assert(false) }
            } else {
                assert(false)
            }
        } else {
            assert(false)
        }
    }
}

tests "JSON.parse string escapes" {
    test "parse slash escape" {
        let r = JSON.parse("\"\\/\"")
        assert(r.ok)
        assert(r.as_string() == "/")
    }

    test "parse backspace escape" {
        let r = JSON.parse("\"\\b\"")
        assert(r.ok)
        assert(r.as_string() == "\b")
    }

    test "parse form feed escape" {
        let r = JSON.parse("\"\\f\"")
        assert(r.ok)
        assert(r.as_string() == "\f")
    }

    test "parse carriage return escape" {
        let r = JSON.parse("\"\\r\"")
        assert(r.ok)
        assert(r.as_string() == "\r")
    }

    test "parse multiple escapes in one string" {
        let r = JSON.parse("\"a\\nb\\tc\"")
        assert(r.ok)
        assert(r.as_string() == "a\nb\tc")
    }
}

tests "JSON.parse complex" {
    test "parse deeply nested" {
        let r = JSON.parse("{{\"a\": {{\"b\": {{\"c\": 1}}}}}}")
        assert(r.ok)
        let obj = r.as_object()
        let a = obj.get("a")
        if a is JsonObject {
            let b = a.get("b")
            if b is JsonObject {
                let c = b.get("c")
                if c is f64 { assert(c == 1.0) } else { assert(false) }
            } else { assert(false) }
        } else { assert(false) }
    }

    test "parse array of objects" {
        let r = JSON.parse("[{{\"id\": 1}}, {{\"id\": 2}}]")
        assert(r.ok)
        let arr = r.as_array()
        assert(arr.length() == 2)
        let first = arr.get(0)
        if first is JsonObject {
            let id = first.get("id")
            if id is f64 { assert(id == 1.0) } else { assert(false) }
        } else { assert(false) }
    }

    test "parse object with escaped string key" {
        let r = JSON.parse("{{\"key\\nwith\\nnewlines\": \"value\"}}")
        assert(r.ok)
        let obj = r.as_object()
        assert(obj.contains_key("key\nwith\nnewlines"))
    }
}
