// Tests for std:env module

let env = import "std:env"

tests "env args" {
    test "args returns an array" {
        let a = env.args()
        // During test execution, we may or may not have args
        // but it should at least return an array
        assert(a.length() >= 0)
    }

    test "args elements are strings" {
        let a = env.args()
        // If there are args, they should be strings
        if a.length() > 0 {
            // Just accessing the first arg shouldn't crash
            let first = a[0]
            assert(first.length() >= 0)
        }
    }
}

tests "env get" {
    test "get returns nil for nonexistent var" {
        let result = env.get("VOLE_NONEXISTENT_VAR_12345_ABCDEF")
        assert(result == nil)
    }

    test "get returns value for PATH" {
        // PATH should exist on all systems
        let result = env.get("PATH")
        // PATH might be nil on some exotic systems, but usually exists
        // Use ?? to provide default for nil case
        let value = result ?? ""
        if value.length() > 0 {
            assert(value.contains(":") || value.contains(";"))
        }
    }

    test "get handles empty string name" {
        let result = env.get("")
        // Empty string is not a valid env var name, should return nil
        assert(result == nil)
    }
}

tests "env vars" {
    test "vars returns an array" {
        let v = env.vars()
        // Should have at least some environment variables
        assert(v.length() > 0)
    }

    test "vars elements are pairs" {
        let v = env.vars()
        assert(v.length() > 0)

        // First element should be a 2-element array
        let first = v[0]
        assert(first.length() == 2)

        // Both elements should be strings
        let key = first[0]
        let value = first[1]
        assert(key.length() >= 0)
        // Value can be empty string
        assert(value.length() >= 0)
    }

    test "vars can be iterated" {
        let v = env.vars()
        var count = 0
        for pair in v {
            count = count + 1
            // Each pair should have 2 elements
            assert(pair.length() == 2)
        }
        assert(count == v.length())
    }
}

tests "env cwd" {
    test "cwd returns non-empty string" {
        let c = env.cwd()
        assert(c.length() > 0)
    }

    test "cwd contains path separator" {
        let c = env.cwd()
        // On Unix, paths contain /; on Windows, they contain \ or /
        assert(c.contains("/") || c.contains("\\"))
    }
}

tests "env exe_path" {
    test "exe_path returns non-empty string" {
        let e = env.exe_path()
        assert(e.length() > 0)
    }

    test "exe_path contains vole" {
        let e = env.exe_path()
        // The executable should be named something with "vole"
        let lower = e.to_lower()
        assert(lower.contains("vole"))
    }
}

tests "env home_dir" {
    test "home_dir returns string or nil" {
        let h = env.home_dir()
        // home_dir may return nil on some systems
        // Use ?? to provide default for nil case
        let value = h ?? ""
        // If we got a value, it should be non-empty
        // We just test that the function returns without error
        assert(value.length() >= 0)
    }

    test "home_dir path looks valid if present" {
        let h = env.home_dir()
        // Use ?? to provide default for nil case
        let value = h ?? ""
        // If we got a non-empty value, it should look like a path
        if value.length() > 0 {
            assert(value.contains("/") || value.contains("\\"))
        }
    }
}

tests "env temp_dir" {
    test "temp_dir returns non-empty string" {
        let t = env.temp_dir()
        assert(t.length() > 0)
    }

    test "temp_dir contains path separator" {
        let t = env.temp_dir()
        // On Unix, paths contain /; on Windows, they contain \ or /
        assert(t.contains("/") || t.contains("\\"))
    }

    test "temp_dir looks like temp path" {
        let t = env.temp_dir()
        let lower = t.to_lower()
        // Common temp dir patterns
        assert(lower.contains("tmp") || lower.contains("temp") || lower.contains("/t"))
    }
}
