// Isolation test for Channel instance methods via Task.stream
// Related to vol-96jm: Channel method dispatch fails for generic module types
//
// This test fails when run in isolation:
//   cargo run -- test test/unit/stdlib/_channel_methods_isolation.vole
//
// Task.stream internally creates a Channel<T> and calls send(), receive(),
// close(), and is_closed() on it. When Channel's monomorphization hasn't
// been pre-compiled by earlier test files, these method lookups fail.
//
// NOTE: Importing Channel and using it directly DOES work in isolation.
// The bug only manifests when Channel methods are called internally by
// Task.stream (i.e., the module code uses Channel, not the user code).
//
// When fixed: remove the _ prefix to include in normal test runs.
let { Task } = import "std:task"

tests {
    test "task.stream i64 for-in loop exercises internal channel send/receive/close" {
        var sum = 0
        let s = Task.stream((emit: (i64) -> void) => {
            emit(1)
            emit(2)
            emit(3)
        })
        for v in s {
            sum = sum + v
        }
        assert(sum == 6)
    }

    test "task.stream f64 exercises internal channel methods" {
        let s = Task.stream((emit: (f64) -> void) => {
            emit(1.5)
            emit(2.5)
        })
        let result = s.collect()
        assert(result.length() == 2)
        assert(result[0] == 1.5)
        assert(result[1] == 2.5)
    }

    test "task.stream bool exercises internal channel methods" {
        let s = Task.stream((emit: (bool) -> void) => {
            emit(true)
            emit(false)
            emit(true)
        })
        let result = s.collect()
        assert(result.length() == 3)
        assert(result[0] == true)
        assert(result[1] == false)
        assert(result[2] == true)
    }
}
