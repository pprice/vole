// Iterator method tests

tests "iterators" {
    test "map" {
        let arr = [1, 2, 3]
        let doubled = arr.map((x) => x * 2).collect()
        assert(doubled.length == 3)
        assert(doubled[0] == 2)
        assert(doubled[1] == 4)
        assert(doubled[2] == 6)
    }

    test "filter" {
        let arr = [1, 2, 3, 4, 5]
        let filtered = arr.filter((x) => x > 2).collect()
        assert(filtered.length == 3)
        assert(filtered[0] == 3)
        assert(filtered[1] == 4)
        assert(filtered[2] == 5)
    }

    test "take" {
        let arr = [1, 2, 3, 4, 5]
        let taken = arr.take(3).collect()
        assert(taken.length == 3)
        assert(taken[0] == 1)
        assert(taken[1] == 2)
        assert(taken[2] == 3)
    }

    test "skip" {
        let arr = [1, 2, 3, 4, 5]
        let skipped = arr.skip(2).collect()
        assert(skipped.length == 3)
        assert(skipped[0] == 3)
        assert(skipped[1] == 4)
        assert(skipped[2] == 5)
    }

    test "reduce" {
        let arr = [1, 2, 3, 4]
        let sum = arr.reduce(0, (acc, x) => acc + x)
        assert(sum == 10)
    }

    test "sum" {
        let arr = [1, 2, 3, 4, 5]
        assert(arr.sum() == 15)
    }

    test "count" {
        let arr = [1, 2, 3]
        assert(arr.count() == 3)
    }

    test "chained operations" {
        let arr = [1, 2, 3, 4, 5, 6]
        let result = arr.filter((x) => x > 2).map((x) => x * 10).take(2).collect()
        assert(result.length == 2)
        assert(result[0] == 30)
        assert(result[1] == 40)
    }

    test "forEach" {
        let arr = [1, 2, 3]
        let mut sum = 0
        arr.forEach((x) => { sum = sum + x })
        assert(sum == 6)
    }

    test "lazy iterator chaining" {
        let iter = [1, 2, 3, 4, 5].map((x) => x + 1)
        let chainedSum = iter.filter((x) => x > 3).sum()
        // [1,2,3,4,5].map(x+1) = [2,3,4,5,6]
        // filter(x > 3) = [4,5,6]
        // sum = 4+5+6 = 15
        assert(chainedSum == 15)
    }

    test "empty result" {
        let emptyResult = [1, 2, 3].filter((x) => x > 10).collect()
        assert(emptyResult.length == 0)
    }

    test "collected array iteration" {
        let forInArr = [10, 20, 30].map((x) => x / 10).collect()
        assert(forInArr.sum() == 6) // 1 + 2 + 3
    }
}
