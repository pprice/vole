// Iterator method tests

tests "iterators" {
    test "array iter returns iterator" {
        let arr = [1, 2, 3]
        let iter = arr.iter()
        assert(true)
    }

    test "iter on empty array" {
        let arr: [i32] = []
        let iter = arr.iter()
        assert(true)
    }

    test "iter on string array" {
        let arr = ["a", "b", "c"]
        let iter = arr.iter()
        assert(true)
    }

    test "multiple iter calls on same array" {
        let arr = [1, 2, 3]
        let iter1 = arr.iter()
        let iter2 = arr.iter()
        assert(true)
    }

    test "iterator next returns value" {
        let arr = [10, 20, 30]
        let iter = arr.iter()

        let first = iter.next()
        // Check that we got a value, not Done
        let not_done = !(first is Done)
        assert(not_done)
    }

    test "iterator next returns done when exhausted" {
        let arr = [1]
        let iter = arr.iter()

        iter.next()  // consume the one element
        let second = iter.next()

        let is_done = second is Done
        assert(is_done)
    }

    test "iterate all elements" {
        let arr = [1, 2, 3]
        let iter = arr.iter()
        let mut count = 0

        // Verify we can call next() three times and get values
        let first = iter.next()
        assert(!(first is Done))
        count = count + 1

        let second = iter.next()
        assert(!(second is Done))
        count = count + 1

        let third = iter.next()
        assert(!(third is Done))
        count = count + 1

        // Fourth call should return Done
        let fourth = iter.next()
        assert(fourth is Done)

        assert(count == 3)
    }

    test "collect to array" {
        let arr = [1, 2, 3]
        let collected = arr.iter().collect()
        assert(collected.length() == 3)
        assert(collected[0] == 1)
        assert(collected[1] == 2)
        assert(collected[2] == 3)
    }

    test "map transforms elements" {
        let arr = [1, 2, 3]
        let doubled = arr.iter().map((x) => x * 2).collect()
        assert(doubled.length() == 3)
        assert(doubled[0] == 2)
        assert(doubled[1] == 4)
        assert(doubled[2] == 6)
    }

    test "map with closure captures" {
        let arr = [1, 2, 3]
        let multiplier = 10
        let result = arr.iter().map((x) => x * multiplier).collect()
        assert(result[0] == 10)
        assert(result[1] == 20)
        assert(result[2] == 30)
    }

    test "chained map" {
        let arr = [1, 2, 3]
        let result = arr.iter().map((x) => x + 1).map((x) => x * 2).collect()
        assert(result[0] == 4)   // (1+1)*2 = 4
        assert(result[1] == 6)   // (2+1)*2 = 6
        assert(result[2] == 8)   // (3+1)*2 = 8
    }
}
