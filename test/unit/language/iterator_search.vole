// Tests for find(), any(), all() iterator methods

tests "iterator search methods" {
    // find() tests

    test "find first matching element" {
        let arr = [1, 2, 3, 4, 5]
        let result = arr.iter().find((x) => x > 3)
        assert(result is i64)
        assert((result ?? 0) == 4)
    }

    test "find returns nil when no match" {
        let arr = [1, 2, 3]
        let result = arr.iter().find((x) => x > 10)
        assert(result is nil)
    }

    test "find on empty iterator" {
        let arr: [i64] = []
        let result = arr.iter().find((x) => x > 0)
        assert(result is nil)
    }

    test "find first even number" {
        let arr = [1, 3, 5, 6, 7, 8]
        let result = arr.iter().find((x) => x % 2 == 0)
        assert(result is i64)
        assert((result ?? 0) == 6)
    }

    test "find with filter chain" {
        let arr = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
        // Filter to evens [2, 4, 6, 8, 10], then find first > 5
        let result = arr.iter().filter((x) => x % 2 == 0).find((x) => x > 5)
        assert(result is i64)
        assert((result ?? 0) == 6)
    }

    test "find with map chain" {
        let arr = [1, 2, 3, 4, 5]
        // Double each: [2, 4, 6, 8, 10], then find first > 7
        let result = arr.iter().map((x) => x * 2).find((x) => x > 7)
        assert(result is i64)
        assert((result ?? 0) == 8)
    }

    test "find with closure capture" {
        let arr = [1, 2, 3, 4, 5]
        let threshold = 3
        let result = arr.iter().find((x) => x > threshold)
        assert(result is i64)
        assert((result ?? 0) == 4)
    }

    // any() tests

    test "any returns true when match exists" {
        let arr = [1, 2, 3, 4, 5]
        assert(arr.iter().any((x) => x > 3))
    }

    test "any returns false when no match" {
        let arr = [1, 2, 3]
        assert(!arr.iter().any((x) => x > 10))
    }

    test "any on empty iterator" {
        let arr: [i64] = []
        assert(!arr.iter().any((x) => x > 0))
    }

    test "any short-circuits on first match" {
        let arr = [1, 2, 3, 4, 5]
        // Should find match at element 4 and stop
        assert(arr.iter().any((x) => x == 4))
    }

    test "any with even check" {
        let arr = [1, 3, 5, 7, 8, 9]
        assert(arr.iter().any((x) => x % 2 == 0))
    }

    test "any all odd returns false" {
        let arr = [1, 3, 5, 7, 9]
        assert(!arr.iter().any((x) => x % 2 == 0))
    }

    test "any with filter chain" {
        let arr = [1, 2, 3, 4, 5]
        // Filter to evens [2, 4], check if any > 3
        assert(arr.iter().filter((x) => x % 2 == 0).any((x) => x > 3))
    }

    test "any with map chain" {
        let arr = [1, 2, 3]
        // Double: [2, 4, 6], check if any > 5
        assert(arr.iter().map((x) => x * 2).any((x) => x > 5))
    }

    test "any with closure capture" {
        let arr = [1, 2, 3, 4, 5]
        let target = 3
        assert(arr.iter().any((x) => x == target))
    }

    // all() tests

    test "all returns true when all match" {
        let arr = [2, 4, 6, 8]
        assert(arr.iter().all((x) => x % 2 == 0))
    }

    test "all returns false when one fails" {
        let arr = [2, 4, 5, 8]
        assert(!arr.iter().all((x) => x % 2 == 0))
    }

    test "all on empty iterator" {
        let arr: [i64] = []
        // Vacuous truth: all elements of empty set match any predicate
        assert(arr.iter().all((x) => x > 1000))
    }

    test "all positive numbers" {
        let arr = [1, 2, 3, 4, 5]
        assert(arr.iter().all((x) => x > 0))
    }

    test "all fails on negative" {
        let arr = [1, 2, -3, 4, 5]
        assert(!arr.iter().all((x) => x > 0))
    }

    test "all short-circuits on first failure" {
        let arr = [1, 2, 0, 4, 5]
        // Should find failure at 0 and stop
        assert(!arr.iter().all((x) => x > 0))
    }

    test "all with filter chain" {
        let arr = [1, 2, 3, 4, 5, 6]
        // Filter to evens [2, 4, 6], check if all < 10
        assert(arr.iter().filter((x) => x % 2 == 0).all((x) => x < 10))
    }

    test "all with map chain" {
        let arr = [1, 2, 3]
        // Double: [2, 4, 6], check if all even
        assert(arr.iter().map((x) => x * 2).all((x) => x % 2 == 0))
    }

    test "all with closure capture" {
        let arr = [1, 2, 3, 4, 5]
        let limit = 10
        assert(arr.iter().all((x) => x < limit))
    }

    // Combined tests

    test "find any all on same data" {
        let arr = [1, 2, 3, 4, 5]

        // Find first even
        let first_even = arr.iter().find((x) => x % 2 == 0)
        assert(first_even is i64)
        assert((first_even ?? 0) == 2)

        // Check if any even exists
        assert(arr.iter().any((x) => x % 2 == 0))

        // Check if all are positive
        assert(arr.iter().all((x) => x > 0))
    }

    test "chained transformations with search" {
        let arr = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]

        // Filter evens, double them, find first > 10
        let result = arr.iter()
            .filter((x) => x % 2 == 0)
            .map((x) => x * 2)
            .find((x) => x > 10)
        assert(result is i64)
        assert((result ?? 0) == 12) // 6 * 2 = 12

        // Filter evens, double them, check if any > 15
        assert(arr.iter()
            .filter((x) => x % 2 == 0)
            .map((x) => x * 2)
            .any((x) => x > 15))

        // Filter evens, double them, check if all < 25
        assert(arr.iter()
            .filter((x) => x % 2 == 0)
            .map((x) => x * 2)
            .all((x) => x < 25))
    }
}
