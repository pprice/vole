// Iterator chunks() and windows() method tests

tests "iterator chunks and windows" {
    // ==========================================================================
    // chunks() tests - non-overlapping chunks
    // ==========================================================================

    test "chunks basic" {
        let arr = [1, 2, 3, 4, 5]
        let c = arr.iter().chunks(2).collect()
        assert(c.length() == 3)
        // First chunk: [1, 2]
        assert(c[0].length() == 2)
        assert(c[0][0] == 1)
        assert(c[0][1] == 2)
        // Second chunk: [3, 4]
        assert(c[1].length() == 2)
        assert(c[1][0] == 3)
        assert(c[1][1] == 4)
        // Last chunk: [5] (smaller than chunk size)
        assert(c[2].length() == 1)
        assert(c[2][0] == 5)
    }

    test "chunks exact division" {
        let arr = [1, 2, 3, 4, 5, 6]
        let c = arr.iter().chunks(2).collect()
        assert(c.length() == 3)
        assert(c[0].length() == 2)
        assert(c[1].length() == 2)
        assert(c[2].length() == 2)
    }

    test "chunks size 1" {
        let arr = [1, 2, 3]
        let c = arr.iter().chunks(1).collect()
        assert(c.length() == 3)
        assert(c[0].length() == 1)
        assert(c[0][0] == 1)
        assert(c[1].length() == 1)
        assert(c[1][0] == 2)
        assert(c[2].length() == 1)
        assert(c[2][0] == 3)
    }

    test "chunks size larger than array" {
        let arr = [1, 2, 3]
        let c = arr.iter().chunks(10).collect()
        assert(c.length() == 1)
        assert(c[0].length() == 3)
        assert(c[0][0] == 1)
        assert(c[0][1] == 2)
        assert(c[0][2] == 3)
    }

    test "chunks empty array" {
        let arr: [i64] = []
        let c = arr.iter().chunks(2).collect()
        assert(c.length() == 0)
    }

    test "chunks single element" {
        let arr = [42]
        let c = arr.iter().chunks(3).collect()
        assert(c.length() == 1)
        assert(c[0].length() == 1)
        assert(c[0][0] == 42)
    }

    test "chunks with map before" {
        let arr = [1, 2, 3, 4]
        let c = arr.iter().map((x) => x * 10).chunks(2).collect()
        assert(c.length() == 2)
        assert(c[0][0] == 10)
        assert(c[0][1] == 20)
        assert(c[1][0] == 30)
        assert(c[1][1] == 40)
    }

    test "chunks with filter before" {
        let arr = [1, 2, 3, 4, 5, 6]
        let c = arr.iter().filter((x) => x % 2 == 0).chunks(2).collect()
        assert(c.length() == 2)
        // Even numbers: 2, 4, 6 -> chunks of 2: [2, 4], [6]
        assert(c[0].length() == 2)
        assert(c[0][0] == 2)
        assert(c[0][1] == 4)
        assert(c[1].length() == 1)
        assert(c[1][0] == 6)
    }

    test "chunks count" {
        let arr = [1, 2, 3, 4, 5]
        let count = arr.iter().chunks(2).count()
        assert(count == 3)
    }

    // ==========================================================================
    // windows() tests - overlapping sliding windows
    // ==========================================================================

    test "windows basic" {
        let arr = [1, 2, 3, 4, 5]
        let w = arr.iter().windows(3).collect()
        assert(w.length() == 3)
        // Window 1: [1, 2, 3]
        assert(w[0].length() == 3)
        assert(w[0][0] == 1)
        assert(w[0][1] == 2)
        assert(w[0][2] == 3)
        // Window 2: [2, 3, 4]
        assert(w[1].length() == 3)
        assert(w[1][0] == 2)
        assert(w[1][1] == 3)
        assert(w[1][2] == 4)
        // Window 3: [3, 4, 5]
        assert(w[2].length() == 3)
        assert(w[2][0] == 3)
        assert(w[2][1] == 4)
        assert(w[2][2] == 5)
    }

    test "windows size 2" {
        let arr = [1, 2, 3, 4]
        let w = arr.iter().windows(2).collect()
        assert(w.length() == 3)
        assert(w[0][0] == 1)
        assert(w[0][1] == 2)
        assert(w[1][0] == 2)
        assert(w[1][1] == 3)
        assert(w[2][0] == 3)
        assert(w[2][1] == 4)
    }

    test "windows size 1" {
        let arr = [1, 2, 3]
        let w = arr.iter().windows(1).collect()
        assert(w.length() == 3)
        assert(w[0].length() == 1)
        assert(w[0][0] == 1)
        assert(w[1][0] == 2)
        assert(w[2][0] == 3)
    }

    test "windows size equals array length" {
        let arr = [1, 2, 3]
        let w = arr.iter().windows(3).collect()
        assert(w.length() == 1)
        assert(w[0].length() == 3)
        assert(w[0][0] == 1)
        assert(w[0][1] == 2)
        assert(w[0][2] == 3)
    }

    test "windows size larger than array" {
        let arr = [1, 2, 3]
        let w = arr.iter().windows(5).collect()
        // No windows possible when window_size > array length
        assert(w.length() == 0)
    }

    test "windows empty array" {
        let arr: [i64] = []
        let w = arr.iter().windows(2).collect()
        assert(w.length() == 0)
    }

    test "windows single element size 1" {
        let arr = [42]
        let w = arr.iter().windows(1).collect()
        assert(w.length() == 1)
        assert(w[0].length() == 1)
        assert(w[0][0] == 42)
    }

    test "windows single element larger size" {
        let arr = [42]
        let w = arr.iter().windows(2).collect()
        assert(w.length() == 0)
    }

    test "windows with map before" {
        let arr = [1, 2, 3, 4]
        let w = arr.iter().map((x) => x * 10).windows(2).collect()
        assert(w.length() == 3)
        assert(w[0][0] == 10)
        assert(w[0][1] == 20)
        assert(w[1][0] == 20)
        assert(w[1][1] == 30)
        assert(w[2][0] == 30)
        assert(w[2][1] == 40)
    }

    test "windows with filter before" {
        let arr = [1, 2, 3, 4, 5, 6]
        let w = arr.iter().filter((x) => x % 2 == 0).windows(2).collect()
        // Even numbers: 2, 4, 6 -> windows of 2: [2, 4], [4, 6]
        assert(w.length() == 2)
        assert(w[0][0] == 2)
        assert(w[0][1] == 4)
        assert(w[1][0] == 4)
        assert(w[1][1] == 6)
    }

    test "windows count" {
        let arr = [1, 2, 3, 4, 5]
        let count = arr.iter().windows(3).count()
        assert(count == 3)
    }

    // ==========================================================================
    // Combined operations
    // ==========================================================================

    test "chunks then flatten" {
        let arr = [1, 2, 3, 4, 5, 6]
        let result = arr.iter().chunks(2).flatten().collect()
        assert(result.length() == 6)
        assert(result[0] == 1)
        assert(result[1] == 2)
        assert(result[2] == 3)
        assert(result[3] == 4)
        assert(result[4] == 5)
        assert(result[5] == 6)
    }

    test "windows then flatten" {
        let arr = [1, 2, 3]
        let result = arr.iter().windows(2).flatten().collect()
        // Windows: [1, 2], [2, 3] -> flattened: 1, 2, 2, 3
        assert(result.length() == 4)
        assert(result[0] == 1)
        assert(result[1] == 2)
        assert(result[2] == 2)
        assert(result[3] == 3)
    }

    test "sorted then chunks" {
        let arr = [3, 1, 4, 1, 5, 9]
        let c = arr.iter().sorted().chunks(2).collect()
        // Sorted: [1, 1, 3, 4, 5, 9] -> chunks: [1, 1], [3, 4], [5, 9]
        assert(c.length() == 3)
        assert(c[0][0] == 1)
        assert(c[0][1] == 1)
        assert(c[1][0] == 3)
        assert(c[1][1] == 4)
        assert(c[2][0] == 5)
        assert(c[2][1] == 9)
    }

    test "filter then windows" {
        let arr = [1, 2, 3, 4, 5, 6, 7, 8]
        let w = arr.iter().filter((x) => x > 3).windows(3).collect()
        // Filtered: [4, 5, 6, 7, 8] -> windows: [4, 5, 6], [5, 6, 7], [6, 7, 8]
        assert(w.length() == 3)
        assert(w[0][0] == 4)
        assert(w[0][1] == 5)
        assert(w[0][2] == 6)
        assert(w[1][0] == 5)
        assert(w[1][1] == 6)
        assert(w[1][2] == 7)
        assert(w[2][0] == 6)
        assert(w[2][1] == 7)
        assert(w[2][2] == 8)
    }

    test "take then chunks" {
        let arr = [1, 2, 3, 4, 5, 6, 7, 8]
        let c = arr.iter().take(5).chunks(2).collect()
        // Take 5: [1, 2, 3, 4, 5] -> chunks: [1, 2], [3, 4], [5]
        assert(c.length() == 3)
        assert(c[0].length() == 2)
        assert(c[1].length() == 2)
        assert(c[2].length() == 1)
    }

    test "skip then windows" {
        let arr = [1, 2, 3, 4, 5]
        let w = arr.iter().skip(2).windows(2).collect()
        // Skip 2: [3, 4, 5] -> windows: [3, 4], [4, 5]
        assert(w.length() == 2)
        assert(w[0][0] == 3)
        assert(w[0][1] == 4)
        assert(w[1][0] == 4)
        assert(w[1][1] == 5)
    }
}
