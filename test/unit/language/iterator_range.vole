// Test range iterator functionality
// Range (e.g., 0..5) should implement Iterable<i64>

tests {
    // Basic range.iter().collect()
    test "range iter collect exclusive" {
        let result = (0..5).iter().collect()
        assert(result.length() == 5)
        assert(result[0] == 0)
        assert(result[1] == 1)
        assert(result[2] == 2)
        assert(result[3] == 3)
        assert(result[4] == 4)
    }

    test "range iter collect inclusive" {
        let result = (0..=4).iter().collect()
        assert(result.length() == 5)
        assert(result[0] == 0)
        assert(result[4] == 4)
    }

    test "range iter empty" {
        let result = (5..5).iter().collect()
        assert(result.length() == 0)
    }

    test "range iter negative" {
        let result = (-3..3).iter().collect()
        assert(result.length() == 6)
        assert(result[0] == -3)
        assert(result[5] == 2)
    }

    // Iterator methods on range
    test "range iter sum" {
        let sum = (1..101).iter().sum()
        assert(sum == 5050)
    }

    test "range iter count" {
        let count = (0..10).iter().count()
        assert(count == 10)
    }

    test "range iter map" {
        let doubled = (1..4).iter().map((x) => x * 2).collect()
        assert(doubled.length() == 3)
        assert(doubled[0] == 2)
        assert(doubled[1] == 4)
        assert(doubled[2] == 6)
    }

    test "range iter filter" {
        let evens = (0..10).iter().filter((x) => x % 2 == 0).collect()
        assert(evens.length() == 5)
        assert(evens[0] == 0)
        assert(evens[1] == 2)
        assert(evens[2] == 4)
        assert(evens[3] == 6)
        assert(evens[4] == 8)
    }

    test "range iter filter and map" {
        let result = (0..10).iter().filter((x) => x % 2 == 0).map((x) => x * 10).collect()
        assert(result.length() == 5)
        assert(result[0] == 0)
        assert(result[1] == 20)
        assert(result[2] == 40)
        assert(result[3] == 60)
        assert(result[4] == 80)
    }

    test "range iter take" {
        let first3 = (0..100).iter().take(3).collect()
        assert(first3.length() == 3)
        assert(first3[0] == 0)
        assert(first3[1] == 1)
        assert(first3[2] == 2)
    }

    test "range iter skip" {
        let after5 = (0..10).iter().skip(5).collect()
        assert(after5.length() == 5)
        assert(after5[0] == 5)
        assert(after5[4] == 9)
    }

    test "range iter reduce" {
        let product = (1..6).iter().reduce(1, (acc, x) => acc * x)
        assert(product == 120)  // 1*2*3*4*5 = 120
    }

    test "range iter first" {
        let first = (10..20).iter().first()
        assert(first != nil)
        assert((first ?? 0) == 10)
    }

    test "range iter last" {
        let last = (10..20).iter().last()
        assert(last != nil)
        assert((last ?? 0) == 19)
    }

    test "range iter find" {
        let found = (0..10).iter().find((x) => x > 5)
        assert(found != nil)
        assert((found ?? 0) == 6)
    }

    test "range iter any" {
        assert((0..10).iter().any((x) => x == 5))
        assert(!(0..10).iter().any((x) => x == 100))
    }

    test "range iter all" {
        assert((0..10).iter().all((x) => x < 100))
        assert(!(0..10).iter().all((x) => x < 5))
    }

    // Range chaining
    test "range iter chain" {
        let result = (0..3).iter().chain((10..13).iter()).collect()
        assert(result.length() == 6)
        assert(result[0] == 0)
        assert(result[2] == 2)
        assert(result[3] == 10)
        assert(result[5] == 12)
    }

    // Complex pipeline
    test "range complex pipeline" {
        // Sum of squares of first 10 natural numbers
        let sum_of_squares = (1..11).iter()
            .map((x) => x * x)
            .sum()
        assert(sum_of_squares == 385)  // 1 + 4 + 9 + 16 + 25 + 36 + 49 + 64 + 81 + 100
    }

    test "range with variables" {
        let start = 5
        let end = 10
        let result = (start..end).iter().collect()
        assert(result.length() == 5)
        assert(result[0] == 5)
        assert(result[4] == 9)
    }
}
