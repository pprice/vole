// Test is operator for type checking and narrowing

tests "is operator basics" {
    test "is returns true for matching type" {
        let x: i64 | string = 5
        assert(x is i64)
    }

    test "is returns false for non-matching type" {
        let x: i64 | string = "hello"
        assert(!(x is i64))
    }

    test "is works as boolean expression" {
        let x: i64 | string = 5
        let is_num: bool = x is i64
        assert(is_num)
    }
}

tests "is operator narrowing in if-statements" {
    test "narrows type in then branch" {
        let x: i64 | string = 5
        if x is i64 {
            let y = x + 1  // x is narrowed to i64
            assert(y == 6)
        } else {
            assert(false)
        }
    }

    test "narrows to string - call length()" {
        let x: i64 | string = "hello"
        if x is string {
            let len = x.length()  // x is narrowed to string
            assert(len == 5)
        } else {
            assert(false)
        }
    }

    test "narrows type in else branch" {
        let x: i64 | string = "hello"
        if x is i64 {
            assert(false)
        } else {
            let len = x.length()  // x is narrowed to string
            assert(len == 5)
        }
    }

    test "narrowing with three types" {
        let x: i64 | string | bool = true
        if x is bool {
            assert(x)  // x is narrowed to bool
        } else {
            // x is narrowed to i64 | string
            assert(false)
        }
    }
}

tests "is operator narrowing in when-expressions (formerly if-expressions)" {
    test "narrows then branch in when-expression" {
        let x: i64 | string = "hello"
        let result = when { x is string => x.length(), _ => 0 }
        assert(result == 5)
    }

    test "narrows else branch in when-expression" {
        let x: i64 | string = 42
        // Explicit is check needed in when (no automatic else-narrowing like if)
        let result = when {
            x is string => x.length(),
            x is i64 => x + 1,
            _ => 0
        }
        assert(result == 43)
    }

    test "when-expression with three-type union" {
        let x: i64 | string | bool = "test"
        let len = when { x is string => x.length(), _ => 0 }
        assert(len == 4)
    }
}

tests "is operator narrowing in when-expressions" {
    test "narrows type in when arm" {
        let x: i64 | string = "hello"
        let result = when {
            x is string => x.length()
            _ => 0
        }
        assert(result == 5)
    }

    test "narrows to i64 in when arm" {
        let x: i64 | string = 42
        let result = when {
            x is i64 => x * 2
            _ => 0
        }
        assert(result == 84)
    }

    test "multiple is checks in when" {
        let x: i64 | string | bool = true
        let result = when {
            x is i64 => "number"
            x is string => "text"
            x is bool => "boolean"
            _ => "unknown"
        }
        assert(result == "boolean")
    }
}

tests "is operator in other contexts" {
    test "is in match guard" {
        let x: i64 | string = 5
        let result = match x {
            _ if x is i64 => "number"
            _ => "other"
        }
        assert(result == "number")
    }

    test "is with function return" {
        func check(x: i64 | string) -> bool {
            return x is i64
        }
        assert(check(5))
        assert(!check("hi"))
    }
}
