// Test generic external functions with type-to-intrinsic mapping via where block.
// This tests the new syntax: func sqrt<T>(x: T) -> T where { f32 => "f32_sqrt", f64 => "f64_sqrt" }

// Declare a generic sqrt function that dispatches to type-specific intrinsics
// Note: commas between mappings are optional
external("vole:compiler_intrinsic") {
    func sqrt<T>(x: T) -> T where {
        f32 => "f32_sqrt"
        f64 => "f64_sqrt"
    }
}

// Also test that commas work (optional commas syntax)
external("vole:compiler_intrinsic") {
    func sqrt_with_commas<T>(x: T) -> T where {
        f32 => "f32_sqrt",
        f64 => "f64_sqrt",
    }
}

// Test exact-vs-default precedence: for f64, exact arm must win over default.
external("vole:compiler_intrinsic") {
    func sqrt_with_default<T>(x: T) -> T where {
        default => "f64_abs"
        f64 => "f64_sqrt"
    }
}

// Test fallback-only mapping with an intrinsic that is valid for all [T] arrays.
external("vole:compiler_intrinsic") {
    func generic_array_len<T>(values: [T]) -> i64 where {
        default => "array_len"
    }
}

tests "generic external functions with where block" {
    test "sqrt<f64> dispatches to f64_sqrt intrinsic" {
        let x: f64 = 4.0
        let result = sqrt(x)
        // sqrt(4.0) = 2.0
        assert(result == 2.0)
    }

    test "sqrt<f32> dispatches to f32_sqrt intrinsic" {
        let x: f32 = 9.0
        let result = sqrt(x)
        // sqrt(9.0) = 3.0
        assert(result == 3.0)
    }

    test "sqrt of 1.0 returns 1.0" {
        let f64_result: f64 = sqrt(1.0)
        assert(f64_result == 1.0)
    }

    test "sqrt of 0.0 returns 0.0" {
        let result: f64 = sqrt(0.0)
        assert(result == 0.0)
    }

    test "sqrt with commas in where block" {
        // Test that commas are optional but allowed
        // This is already tested by parsing the func above, but we verify it works at runtime
        let x: f64 = 16.0
        let result = sqrt(x)
        assert(result == 4.0)
    }

    test "sqrt_with_commas function with commas in where block" {
        // Test that the function declared with commas works correctly
        let x: f64 = 25.0
        let result = sqrt_with_commas(x)
        assert(result == 5.0)
    }

    test "exact arm is preferred over default arm" {
        let x: f64 = 9.0
        let result = sqrt_with_default(x)
        // Exact f64 => f64_sqrt should win over default f64_abs.
        assert(result == 3.0)
    }

    test "default arm fallback works for generic array len on i64" {
        let values: [i64] = [1, 2, 3, 4]
        assert(generic_array_len(values) == 4)
    }

    test "default arm fallback works for generic array len on string" {
        let values: [string] = ["a", "bb"]
        assert(generic_array_len(values) == 2)
    }
}
