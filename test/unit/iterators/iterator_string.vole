// String iterator tests - iterating over unicode characters

tests "string iterator" {
    test "string iter returns iterator" {
        let s = "hello"
        let iter = s.iter()
        assert(true)
    }

    test "empty string iter" {
        let s = ""
        let iter = s.iter()
        let result = iter.collect()
        assert(result.length() == 0)
    }

    test "single character string iter" {
        let s = "a"
        let chars = s.iter().collect()
        assert(chars.length() == 1)
        assert(chars[0] == "a")
    }

    test "basic string iteration collect" {
        let s = "hello"
        let chars = s.iter().collect()
        assert(chars.length() == 5)
        assert(chars[0] == "h")
        assert(chars[1] == "e")
        assert(chars[2] == "l")
        assert(chars[3] == "l")
        assert(chars[4] == "o")
    }

    test "string iter count" {
        let s = "hello"
        assert(s.iter().count() == 5)
    }

    test "empty string iter count" {
        let s = ""
        assert(s.iter().count() == 0)
    }

    // Unicode tests

    test "unicode string iter collect" {
        let s = "abc"
        let chars = s.iter().collect()
        assert(chars.length() == 3)
        assert(chars[0] == "a")
        assert(chars[1] == "b")
        assert(chars[2] == "c")
    }

    test "unicode cjk characters" {
        // Japanese: nihongo (Japan)
        let s = "日本語"
        let chars = s.iter().collect()
        assert(chars.length() == 3)
        assert(chars[0] == "日")
        assert(chars[1] == "本")
        assert(chars[2] == "語")
    }

    test "unicode emoji characters" {
        let s = "ab"
        let chars = s.iter().collect()
        assert(chars.length() == 2)
    }

    test "unicode mixed characters" {
        let s = "cafe"
        let chars = s.iter().collect()
        assert(chars.length() == 4)
        assert(chars[0] == "c")
        assert(chars[1] == "a")
        assert(chars[2] == "f")
        assert(chars[3] == "e")
    }

    test "unicode accented character" {
        // e with acute accent
        let s = "cafe"
        let count = s.iter().count()
        assert(count == 4)
    }

    // Iterator methods

    test "string iter map" {
        let s = "abc"
        // Map each char to itself (identity)
        let result = s.iter().map((ch) => ch).collect()
        assert(result.length() == 3)
        assert(result[0] == "a")
        assert(result[1] == "b")
        assert(result[2] == "c")
    }

    test "string iter filter always true" {
        let s = "hello"
        // Filter with always true - verifies filter works with string iterator
        let result = s.iter().filter((ch) => true).collect()
        assert(result.length() == 5)
        assert(result[0] == "h")
        assert(result[4] == "o")
    }

    test "string iter take" {
        let s = "hello world"
        let chars = s.iter().take(5).collect()
        assert(chars.length() == 5)
        assert(chars[0] == "h")
        assert(chars[4] == "o")
    }

    test "string iter skip" {
        let s = "hello"
        let chars = s.iter().skip(2).collect()
        assert(chars.length() == 3)
        assert(chars[0] == "l")
        assert(chars[1] == "l")
        assert(chars[2] == "o")
    }

    test "string iter chained operations" {
        let s = "abcdefgh"
        // Skip first 2, take next 4
        let chars = s.iter().skip(2).take(4).collect()
        assert(chars.length() == 4)
        assert(chars[0] == "c")
        assert(chars[1] == "d")
        assert(chars[2] == "e")
        assert(chars[3] == "f")
    }

    test "string iter for_each" {
        let s = "abc"
        s.iter().for_each((ch) => { let x = ch })
        assert(true)
    }

    test "string iter reduce" {
        // Concatenate characters using reduce
        let s = "abc"
        let result = s.iter().reduce("", (acc, ch) => acc)
        // Just verify reduce runs without error on string iterator
        assert(true)
    }

    test "string iter first" {
        let s = "hello"
        let first = s.iter().first()
        assert(first is string)
        assert((first ?? "") == "h")
    }

    test "string iter first empty" {
        let s = ""
        let first = s.iter().first()
        assert(first is nil)
    }

    test "string iter last" {
        let s = "hello"
        let last = s.iter().last()
        assert(last is string)
        assert((last ?? "") == "o")
    }

    test "string iter nth" {
        let s = "hello"
        let ch = s.iter().nth(2)
        assert(ch is string)
        assert((ch ?? "") == "l")
    }

    test "string iter nth out of bounds" {
        let s = "hi"
        let ch = s.iter().nth(10)
        assert(ch is nil)
    }

    test "unicode string count" {
        // Each character counts as 1
        let s = "日本語"
        assert(s.iter().count() == 3)
    }

    test "for loop over string" {
        let s = "abc"
        var count = 0
        for ch in s {
            count = count + 1
        }
        assert(count == 3)
    }

    test "for loop over unicode string" {
        let s = "日本語"
        var count = 0
        for ch in s {
            count = count + 1
        }
        assert(count == 3)
    }

    test "for loop with string collection" {
        let s = "hi"
        let chars = s.iter().collect()
        assert(chars.length() == 2)
        assert(chars[0] == "h")
        assert(chars[1] == "i")
    }
}
