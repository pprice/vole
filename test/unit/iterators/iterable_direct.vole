// Tests for calling Iterable<T> default methods directly on Array, String, and Range
// without an explicit .iter() call. Regression tests for vol-2zvv.

tests "iterable direct" {

    // -------------------------------------------------------------------------
    // Array: direct Iterable methods
    // -------------------------------------------------------------------------

    test "array direct count" {
        assert([1, 2, 3].count() == 3)
    }

    test "array direct count empty" {
        let arr: [i64] = []
        assert(arr.count() == 0)
    }

    test "array direct map collect" {
        let doubled = [1, 2, 3].map((x) => x * 2).collect()
        assert(doubled.length() == 3)
        assert(doubled[0] == 2)
        assert(doubled[1] == 4)
        assert(doubled[2] == 6)
    }

    test "array direct filter collect" {
        let evens = [1, 2, 3, 4, 5].filter((x) => x % 2 == 0).collect()
        assert(evens.length() == 2)
        assert(evens[0] == 2)
        assert(evens[1] == 4)
    }

    test "array direct reduce sum" {
        let total = [1, 2, 3, 4, 5].reduce(0, (acc, x) => acc + x)
        assert(total == 15)
    }

    test "array direct first" {
        let first = [10, 20, 30].first()
        assert((first ?? 0) == 10)
    }

    test "array direct first empty" {
        let arr: [i64] = []
        let first = arr.first()
        assert(first is nil)
    }

    test "array direct any true" {
        assert([1, 2, 3].any((x) => x > 2))
    }

    test "array direct any false" {
        assert(!([1, 2, 3].any((x) => x > 10)))
    }

    test "array direct all true" {
        assert([1, 2, 3].all((x) => x > 0))
    }

    test "array direct all false" {
        assert(!([1, 2, 3].all((x) => x > 1)))
    }

    test "array direct map then count" {
        let count = [1, 2, 3].map((x) => x * 2).count()
        assert(count == 3)
    }

    test "array direct filter then count" {
        let count = [1, 2, 3, 4, 5].filter((x) => x % 2 == 0).count()
        assert(count == 2)
    }

    test "array direct take collect" {
        let first2 = [10, 20, 30, 40].take(2).collect()
        assert(first2.length() == 2)
        assert(first2[0] == 10)
        assert(first2[1] == 20)
    }

    test "array direct filter map collect" {
        let result = [1, 2, 3, 4, 5].filter((x) => x % 2 == 1).map((x) => x * 10).collect()
        assert(result.length() == 3)
        assert(result[0] == 10)
        assert(result[1] == 30)
        assert(result[2] == 50)
    }

    test "array direct sum" {
        assert([1, 2, 3, 4].sum() == 10)
    }

    test "array direct find" {
        let found = [1, 2, 3, 4, 5].find((x) => x > 3)
        assert((found ?? 0) == 4)
    }

    test "array direct last" {
        let last = [10, 20, 30].last()
        assert((last ?? 0) == 30)
    }

    // -------------------------------------------------------------------------
    // Range: direct Iterable methods
    // -------------------------------------------------------------------------

    test "range direct count" {
        assert((0..5).count() == 5)
    }

    test "range direct count inclusive" {
        assert((1..=5).count() == 5)
    }

    test "range direct count empty" {
        assert((5..5).count() == 0)
    }

    test "range direct map collect" {
        let doubled = (1..4).map((x) => x * 2).collect()
        assert(doubled.length() == 3)
        assert(doubled[0] == 2)
        assert(doubled[1] == 4)
        assert(doubled[2] == 6)
    }

    test "range direct filter collect" {
        let evens = (0..10).filter((x) => x % 2 == 0).collect()
        assert(evens.length() == 5)
        assert(evens[0] == 0)
        assert(evens[1] == 2)
        assert(evens[2] == 4)
        assert(evens[3] == 6)
        assert(evens[4] == 8)
    }

    test "range direct take collect" {
        let first3 = (0..100).take(3).collect()
        assert(first3.length() == 3)
        assert(first3[0] == 0)
        assert(first3[1] == 1)
        assert(first3[2] == 2)
    }

    test "range direct sum" {
        assert((1..=10).sum() == 55)
    }

    test "range direct reduce product" {
        let product = (1..6).reduce(1, (acc, x) => acc * x)
        assert(product == 120)
    }

    test "range direct filter count" {
        let count = (0..10).filter((x) => x % 2 == 0).count()
        assert(count == 5)
    }

    test "range direct any" {
        assert((0..10).any((x) => x == 5))
    }

    test "range direct all" {
        assert((0..10).all((x) => x < 100))
    }

    test "range direct first" {
        let first = (10..20).first()
        assert((first ?? 0) == 10)
    }

    test "range direct last" {
        let last = (10..20).last()
        assert((last ?? 0) == 19)
    }

    test "range direct map sum" {
        // Sum of squares 1..=5: 1+4+9+16+25 = 55
        let result = (1..=5).map((x) => x * x).sum()
        assert(result == 55)
    }

    test "range direct filter map collect" {
        // Even numbers in 0..10 doubled
        let result = (0..6).filter((x) => x % 2 == 0).map((x) => x * 2).collect()
        assert(result.length() == 3)
        assert(result[0] == 0)
        assert(result[1] == 4)
        assert(result[2] == 8)
    }

    test "range direct map with closure capture" {
        let factor = 3
        let result = (1..4).map((x) => x * factor).collect()
        assert(result.length() == 3)
        assert(result[0] == 3)
        assert(result[1] == 6)
        assert(result[2] == 9)
    }

    // -------------------------------------------------------------------------
    // String: direct Iterable methods
    // -------------------------------------------------------------------------

    test "string direct count" {
        assert("hello".count() == 5)
    }

    test "string direct count empty" {
        assert("".count() == 0)
    }

    test "string direct first" {
        let first = "hello".first()
        assert((first ?? "") == "h")
    }

    test "string direct first empty" {
        let first = "".first()
        assert(first is nil)
    }

    test "string direct take collect" {
        let chars = "hello".take(3).collect()
        assert(chars.length() == 3)
        assert(chars[0] == "h")
        assert(chars[1] == "e")
        assert(chars[2] == "l")
    }

    test "string direct filter count" {
        // Keep only 'l' characters
        let count = "hello".filter((ch) => ch == "l").count()
        assert(count == 2)
    }

    test "string direct map collect identity" {
        let chars = "abc".map((ch) => ch).collect()
        assert(chars.length() == 3)
        assert(chars[0] == "a")
        assert(chars[1] == "b")
        assert(chars[2] == "c")
    }
}
