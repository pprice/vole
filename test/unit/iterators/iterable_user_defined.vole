// Tests for user-defined classes implementing Iterable<T>
// Validates the interface default method path (not just the builtin fast path).
// Regression tests for the Iterable<T> wiring introduced in vol-2zvv and vol-9izl.
//
// NOTE: All tests in this file are currently failing due to a codegen bug tracked in:
//   vol-dc87  (union variant type mismatch when calling Iterable<T> default methods
//               on user-defined classes — the sentinel/Done union type is duplicated
//               during generic substitution and the two instances are not unified)
//
// DO NOT SKIP OR SIMPLIFY these tests. They document intended behaviour.

// A simple iterator over a range of integers.
class UserRangeIter {
    current: i64,
    end_val: i64,
}

extend UserRangeIter with Iterator<i64> {
    func next() -> i64 | Done {
        if self.current >= self.end_val {
            return Done {}
        }
        let v = self.current
        self.current = self.current + 1
        return v
    }
}

// A simple custom iterable that wraps a range.
// Implements only iter() — all other methods come from Iterable<T> defaults.
class UserRange {
    start: i64,
    end_val: i64,
}

extend UserRange with Iterable<i64> {
    func iter() -> Iterator<i64> {
        return UserRangeIter { current: self.start, end_val: self.end_val }
    }
}

func make_user_range(start: i64, end_val: i64) -> Iterable<i64> {
    return UserRange { start: start, end_val: end_val }
}

tests "user-defined iterable: default methods" {
    // These tests validate vol-2zvv: Iterable<T> default methods wired up via the
    // interface mechanism. They call methods that are NOT explicitly implemented on
    // UserRange — they must come from Iterable<T> default methods calling self.iter().

    test "count via Iterable default method" {
        let r = make_user_range(0, 5)
        assert(r.count() == 5)
    }

    test "collect via Iterable default method" {
        let r = make_user_range(1, 4)
        let arr = r.collect()
        assert(arr.length() == 3)
        assert(arr[0] == 1)
        assert(arr[1] == 2)
        assert(arr[2] == 3)
    }

    test "sum via Iterable default method" {
        // 1 + 2 + 3 + 4 + 5 = 15
        let r = make_user_range(1, 6)
        assert(r.sum() == 15)
    }

    test "map collect via Iterable default method" {
        let r = make_user_range(1, 4)
        let doubled = r.map((x) => x * 2).collect()
        assert(doubled.length() == 3)
        assert(doubled[0] == 2)
        assert(doubled[1] == 4)
        assert(doubled[2] == 6)
    }

    test "filter collect via Iterable default method" {
        let r = make_user_range(0, 6)
        let evens = r.filter((x) => x % 2 == 0).collect()
        assert(evens.length() == 3)
        assert(evens[0] == 0)
        assert(evens[1] == 2)
        assert(evens[2] == 4)
    }

    test "reduce via Iterable default method" {
        // 1 * 2 * 3 = 6
        let r = make_user_range(1, 4)
        let product = r.reduce(1, (acc, x) => acc * x)
        assert(product == 6)
    }

    test "first via Iterable default method" {
        let r = make_user_range(10, 20)
        let first = r.first()
        assert((first ?? -1) == 10)
    }

    test "any via Iterable default method" {
        let r = make_user_range(0, 10)
        assert(r.any((x) => x == 5))
    }

    test "all via Iterable default method" {
        let r = make_user_range(0, 5)
        assert(r.all((x) => x < 100))
    }
}
