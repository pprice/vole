// Iterator query method tests: first(), last(), nth()

tests "iterator query methods" {
    // first() tests

    test "first on non-empty array" {
        let arr = [1, 2, 3]
        let result = arr.iter().first()
        assert(result != nil)
        assert((result ?? 0) == 1)
    }

    test "first on single element array" {
        let arr = [42]
        let result = arr.iter().first()
        assert(result != nil)
        assert((result ?? 0) == 42)
    }

    test "first on empty array" {
        let arr: [i64] = []
        let result = arr.iter().first()
        assert(result == nil)
    }

    test "first with map" {
        let arr = [1, 2, 3]
        let result = arr.iter().map((x) => x * 10).first()
        assert(result != nil)
        assert((result ?? 0) == 10)
    }

    test "first with filter" {
        let arr = [1, 2, 3, 4, 5]
        let result = arr.iter().filter((x) => x > 3).first()
        assert(result != nil)
        assert((result ?? 0) == 4)
    }

    test "first with filter that matches nothing" {
        let arr = [1, 2, 3]
        let result = arr.iter().filter((x) => x > 10).first()
        assert(result == nil)
    }

    test "first with skip" {
        let arr = [1, 2, 3, 4, 5]
        let result = arr.iter().skip(2).first()
        assert(result != nil)
        assert((result ?? 0) == 3)
    }

    test "first with take" {
        let arr = [1, 2, 3, 4, 5]
        let result = arr.iter().take(3).first()
        assert(result != nil)
        assert((result ?? 0) == 1)
    }

    // last() tests

    test "last on non-empty array" {
        let arr = [1, 2, 3]
        let result = arr.iter().last()
        assert(result != nil)
        assert((result ?? 0) == 3)
    }

    test "last on single element array" {
        let arr = [42]
        let result = arr.iter().last()
        assert(result != nil)
        assert((result ?? 0) == 42)
    }

    test "last on empty array" {
        let arr: [i64] = []
        let result = arr.iter().last()
        assert(result == nil)
    }

    test "last with map" {
        let arr = [1, 2, 3]
        let result = arr.iter().map((x) => x * 10).last()
        assert(result != nil)
        assert((result ?? 0) == 30)
    }

    test "last with filter" {
        let arr = [1, 2, 3, 4, 5]
        let result = arr.iter().filter((x) => x % 2 == 0).last()
        assert(result != nil)
        assert((result ?? 0) == 4)
    }

    test "last with filter that matches nothing" {
        let arr = [1, 2, 3]
        let result = arr.iter().filter((x) => x > 10).last()
        assert(result == nil)
    }

    test "last with take" {
        let arr = [1, 2, 3, 4, 5]
        let result = arr.iter().take(3).last()
        assert(result != nil)
        assert((result ?? 0) == 3)
    }

    test "last with skip" {
        let arr = [1, 2, 3, 4, 5]
        let result = arr.iter().skip(3).last()
        assert(result != nil)
        assert((result ?? 0) == 5)
    }

    // nth() tests

    test "nth element 0" {
        let arr = [10, 20, 30]
        let result = arr.iter().nth(0)
        assert(result != nil)
        assert((result ?? 0) == 10)
    }

    test "nth element 1" {
        let arr = [10, 20, 30]
        let result = arr.iter().nth(1)
        assert(result != nil)
        assert((result ?? 0) == 20)
    }

    test "nth element 2" {
        let arr = [10, 20, 30]
        let result = arr.iter().nth(2)
        assert(result != nil)
        assert((result ?? 0) == 30)
    }

    test "nth beyond array bounds" {
        let arr = [1, 2, 3]
        let result = arr.iter().nth(5)
        assert(result == nil)
    }

    test "nth on empty array" {
        let arr: [i64] = []
        let result = arr.iter().nth(0)
        assert(result == nil)
    }

    test "nth with map" {
        let arr = [1, 2, 3, 4, 5]
        let result = arr.iter().map((x) => x * 2).nth(2)
        assert(result != nil)
        assert((result ?? 0) == 6)  // 3 * 2
    }

    test "nth with filter" {
        let arr = [1, 2, 3, 4, 5, 6]
        // Evens: [2, 4, 6], nth(1) = 4
        let result = arr.iter().filter((x) => x % 2 == 0).nth(1)
        assert(result != nil)
        assert((result ?? 0) == 4)
    }

    test "nth with skip" {
        let arr = [1, 2, 3, 4, 5]
        // Skip 2: [3, 4, 5], nth(1) = 4
        let result = arr.iter().skip(2).nth(1)
        assert(result != nil)
        assert((result ?? 0) == 4)
    }

    test "nth with take" {
        let arr = [1, 2, 3, 4, 5]
        // Take 3: [1, 2, 3], nth(2) = 3
        let result = arr.iter().take(3).nth(2)
        assert(result != nil)
        assert((result ?? 0) == 3)
    }

    test "nth beyond take bounds" {
        let arr = [1, 2, 3, 4, 5]
        // Take 2: [1, 2], nth(3) = nil
        let result = arr.iter().take(2).nth(3)
        assert(result == nil)
    }

    // Edge cases and chaining

    test "first equals nth(0)" {
        let arr = [5, 10, 15]
        let first_result = arr.iter().first()
        let nth_result = arr.iter().nth(0)
        assert((first_result ?? 0) == (nth_result ?? 0))
    }

    test "chained operations with first" {
        let arr = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
        // Filter evens: [2, 4, 6, 8, 10], map double: [4, 8, 12, 16, 20], first: 4
        let result = arr.iter().filter((x) => x % 2 == 0).map((x) => x * 2).first()
        assert(result != nil)
        assert((result ?? 0) == 4)
    }

    test "chained operations with last" {
        let arr = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
        // Filter evens: [2, 4, 6, 8, 10], map double: [4, 8, 12, 16, 20], take 3: [4, 8, 12], last: 12
        let result = arr.iter().filter((x) => x % 2 == 0).map((x) => x * 2).take(3).last()
        assert(result != nil)
        assert((result ?? 0) == 12)
    }

    test "chained operations with nth" {
        let arr = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10]
        // Skip 3: [4, 5, 6, 7, 8, 9, 10], filter > 6: [7, 8, 9, 10], nth(2): 9
        let result = arr.iter().skip(3).filter((x) => x > 6).nth(2)
        assert(result != nil)
        assert((result ?? 0) == 9)
    }
}
