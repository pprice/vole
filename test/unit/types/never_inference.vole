// Unit tests for never type inference in control flow expressions
// The never type (bottom type) unifies with any other type

tests {
    test "when with unreachable in false branch infers true branch type" {
        let x = when {
            true => 42,
            _ => unreachable
        }
        // x should be i64, not never
        assert(x == 42)
    }

    test "when with unreachable in true branch infers false branch type" {
        let x = when {
            false => unreachable,
            _ => "hello"
        }
        // x should be string
        assert(x == "hello")
    }

    test "when both branches unreachable infers never" {
        // This is unusual but valid - both branches are never
        func diverge() -> never {
            _ = when {
                true => unreachable,
                _ => unreachable
            }
        }
        // Can't call diverge() since it would panic
        assert(true)
    }

    test "match with unreachable in default arm infers pattern type" {
        let x: i64 = 5
        let result = match x {
            5 => "five",
            10 => "ten",
            _ => unreachable
        }
        assert(result == "five")
    }

    test "match with unreachable in first arm infers other arms type" {
        let x: i64 = 10  // not 5, so won't hit unreachable
        let result = match x {
            5 => unreachable,
            _ => 100
        }
        // result should be i64
        assert(result == 100)
    }

    test "when with unreachable arm infers correct type" {
        let x = 5
        let result = when {
            x == 5 => "match",
            _ => unreachable
        }
        assert(result == "match")
    }

    test "nested when with unreachable" {
        let x = when {
            true => when {
                false => unreachable,
                _ => 1
            },
            _ => 2
        }
        assert(x == 1)
    }

    test "function returning never can be used in when branch" {
        func always_panics() -> never {
            _ = unreachable
        }

        let x = when {
            true => 42,
            _ => always_panics()
        }
        assert(x == 42)
    }

    test "never type propagates through function return" {
        // Function using explicit return with when
        func foo(cond: bool) -> i64 {
            return when {
                cond => 42,
                _ => unreachable
            }
        }
        assert(foo(true) == 42)
    }

    test "match all arms unreachable infers never" {
        func diverge(x: i64) -> never {
            _ = match x {
                1 => unreachable,
                _ => unreachable
            }
        }
        assert(true)
    }
}
