// RC tests for Map type.
//
// Maps are heap-allocated and reference-counted. These tests exercise
// creation, insertion, lookup, removal, and reassignment to verify RC
// inc/dec correctness when maps go out of scope.
let { Map } = import "std:collections/map"

tests "map basics" {
    test "create empty map and scope exit" {
        let m = Map.new<i64, i64>()
        assert(m.len() == 0)
        assert(m.is_empty())
    }

    test "insert entries then scope exit" {
        let m = Map.new<i64, i64>()
        m.set(1, 100)
        m.set(2, 200)
        m.set(3, 300)
        assert(m.len() == 3)
        assert(!m.is_empty())
    }

    test "lookup values by key" {
        let m = Map.new<i64, i64>()
        m.set(10, 42)
        m.set(20, 84)
        assert(m.get(10) == 42)
        assert(m.get(20) == 84)
        assert(m.get(30) == nil)
        assert(m.contains_key(10))
        assert(!m.contains_key(30))
    }

    test "remove entry and verify cleanup" {
        let m = Map.new<i64, i64>()
        m.set(1, 11)
        m.set(2, 22)
        m.set(3, 33)
        assert(m.len() == 3)
        let removed = m.remove(2)
        assert(removed == 22)
        assert(m.len() == 2)
        assert(!m.contains_key(2))
        assert(m.get(1) == 11)
        assert(m.get(3) == 33)
    }

    test "overwrite existing key" {
        let m = Map.new<i64, i64>()
        m.set(1, 100)
        assert(m.get(1) == 100)
        m.set(1, 999)
        assert(m.get(1) == 999)
        assert(m.len() == 1)
    }

    test "reassign map variable" {
        var m = Map.new<i64, i64>()
        m.set(1, 10)
        m.set(2, 20)
        assert(m.len() == 2)
        m = Map.new<i64, i64>()
        assert(m.len() == 0)
        assert(m.is_empty())
        m.set(3, 30)
        assert(m.get(3) == 30)
        assert(m.len() == 1)
    }
}
