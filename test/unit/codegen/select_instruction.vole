// Test: Select instruction optimization for simple conditionals
//
// This tests that simple if/when expressions with pure expressions
// can use the select instruction instead of creating multiple blocks.

tests "select instruction optimization" {
    // --- If expression tests ---

    test "if expression with integer literals uses select" {
        let x = 5
        let result = if x > 0 { 10 } else { 20 }
        assert(result == 10)
    }

    test "if expression with variables uses select" {
        let a = 100
        let b = 200
        let cond = true
        // Note: using `cond == true` due to parser limitation with bare identifier conditions
        let result = if cond == true { a } else { b }
        assert(result == 100)
    }

    test "if expression with arithmetic uses select" {
        let x = 5
        let y = 3
        let result = if x > y { x + y } else { x - y }
        assert(result == 8)
    }

    test "if expression with nested arithmetic" {
        let a = 10
        let b = 20
        let c = 30
        let result = if a < b { a * 2 + c } else { b * 2 - c }
        assert(result == 50)  // 10 * 2 + 30
    }

    test "if expression with boolean result" {
        let x = 5
        let result = if x > 0 { true } else { false }
        assert(result == true)
    }

    test "if expression with float literals" {
        let x = 1.0
        let result = if x > 0.0 { 3.14 } else { 2.71 }
        assert(result == 3.14)
    }

    test "if expression with unary operators" {
        let x = 5
        let result = if x > 0 { -x } else { x }
        assert(result == -5)
    }

    test "if expression with comparison" {
        let a = 10
        let b = 20
        let result = if a < b { a == 10 } else { b == 20 }
        assert(result == true)
    }

    // --- When expression tests (binary form) ---

    test "binary when expression uses select" {
        let x = 5
        let result = when {
            x > 0 => 10,
            _ => 20
        }
        assert(result == 10)
    }

    test "binary when with arithmetic" {
        let a = 7
        let b = 3
        let result = when {
            a > b => a - b,
            _ => b - a
        }
        assert(result == 4)
    }

    test "binary when with variables" {
        let positive = 100
        let negative = -50
        let x = 1
        let result = when {
            x > 0 => positive,
            _ => negative
        }
        assert(result == 100)
    }

    // --- Edge cases ---

    test "select with same value both sides" {
        let x = 5
        let result = if x > 0 { 42 } else { 42 }
        assert(result == 42)
    }

    test "nested selectable expressions" {
        let a = 1
        let b = 2
        let c = 3
        // Both branches involve multiple operations but still selectable
        let result = if a < b { (a + b) * c } else { (a - b) * c }
        assert(result == 9)  // (1 + 2) * 3
    }

    test "select with bitwise operations" {
        let x = 5
        let result = if x > 0 { x & 3 } else { x | 3 }
        assert(result == 1)  // 5 & 3 = 1
    }

    test "chained comparisons in condition" {
        let x = 5
        let result = if x > 0 && x < 10 { 1 } else { 2 }
        assert(result == 1)
    }

    // --- Cases that should NOT use select (but still work correctly) ---
    // These have side effects or control flow, so they fall back to blocks

    test "if with function call in branch (no select)" {
        func double(n: i64) -> i64 => n * 2
        let x = 5
        let result = if x > 0 { double(x) } else { x }
        assert(result == 10)
    }

    test "if statement without else (no select, not an expression)" {
        let x = 5
        let mut result = 0
        if x > 0 { result = x }
        assert(result == 5)
    }

    test "when with three arms (no select)" {
        let x = 5
        let result = when {
            x < 0 => -1,
            x > 0 => 1,
            _ => 0
        }
        assert(result == 1)
    }

    test "if with block expression (no select)" {
        let x = 5
        let result = if x > 0 {
            let y = x
            y * 2
        } else { x }
        assert(result == 10)
    }

    // --- Verify select works for false conditions too ---

    test "if expression false condition" {
        let x = -5
        let result = if x > 0 { 10 } else { 20 }
        assert(result == 20)
    }

    test "binary when false condition" {
        let x = -5
        let result = when {
            x > 0 => 10,
            _ => 20
        }
        assert(result == 20)
    }

    // --- Mixed integer types ---

    test "select with different integer literals" {
        let x = 1
        let result = if x > 0 { 100 } else { -100 }
        assert(result == 100)
    }

    test "select with zero" {
        let x = 0
        let result = if x == 0 { 0 } else { 1 }
        assert(result == 0)
    }
}
